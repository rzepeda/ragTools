========================================
Test Results - 2025-12-14 07:31:18
========================================
Environment Configuration:
  EMBEDDING_MODEL_NAME: Xenova/all-mpnet-base-v2
  EMBEDDING_MODEL_PATH: models/embedding
  LM_STUDIO_BASE_URL: http://192.168.56.1:1234/v1
  LM_STUDIO_MODEL: phi-4-mini-instruct

Command: pytest tests/integration/services/test_service_implementations.py tests/integration/strategies/test_query_expansion_integration.py tests/unit/strategies/agentic/test_strategy.py tests/unit/documentation/test_links.py tests/unit/documentation/test_code_examples.py tests/unit/cli/test_check_consistency_command.py tests/unit/cli/test_repl_command.py tests/unit/services/test_interfaces.py tests/unit/services/test_database_service.py tests/unit/documentation/test_documentation_completeness.py tests/unit/database/test_migrations.py tests/unit/repositories/test_chunk_repository.py tests/unit/services/embeddings/test_onnx_local.py tests/unit/services/embedding/test_onnx_local_provider.py tests/unit/strategies/late_chunking/test_document_embedder.py tests/unit/test_pipeline.py
========================================

============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.1, pluggy-1.6.0 -- /mnt/MCPProyects/ragTools/venv/bin/python3
cachedir: .pytest_cache
rootdir: /mnt/MCPProyects/ragTools
configfile: pytest.ini (WARNING: ignoring pytest config in pyproject.toml!)
plugins: anyio-4.12.0, cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 209 items

tests/integration/services/test_service_implementations.py::TestONNXServices::test_onnx_embedding_service_implements_interface PASSED [  0%]
tests/integration/services/test_service_implementations.py::TestONNXServices::test_onnx_embedding_service_basic_functionality PASSED [  0%]
tests/integration/services/test_service_implementations.py::TestAPIServices::test_anthropic_llm_service_implements_interface PASSED [  1%]
tests/integration/services/test_service_implementations.py::TestAPIServices::test_anthropic_llm_service_basic_functionality PASSED [  1%]
tests/integration/services/test_service_implementations.py::TestAPIServices::test_openai_llm_service_implements_interface PASSED [  2%]
tests/integration/services/test_service_implementations.py::TestAPIServices::test_openai_embedding_service_implements_interface PASSED [  2%]
tests/integration/services/test_service_implementations.py::TestAPIServices::test_cohere_reranking_service_implements_interface PASSED [  3%]
tests/integration/services/test_service_implementations.py::TestAPIServices::test_cohere_reranking_service_basic_functionality PASSED [  3%]
tests/integration/services/test_service_implementations.py::TestDatabaseServices::test_neo4j_graph_service_implements_interface PASSED [  4%]
tests/integration/services/test_service_implementations.py::TestDatabaseServices::test_neo4j_graph_service_basic_functionality SKIPPED [  4%]
tests/integration/services/test_service_implementations.py::TestDatabaseServices::test_postgresql_database_service_implements_interface PASSED [  5%]
tests/integration/services/test_service_implementations.py::TestDatabaseServices::test_postgresql_database_service_basic_functionality FAILED [  5%]
tests/integration/services/test_service_implementations.py::TestLocalServices::test_cosine_reranking_service_implements_interface PASSED [  6%]
tests/integration/services/test_service_implementations.py::TestLocalServices::test_cosine_reranking_service_basic_functionality PASSED [  6%]
tests/integration/services/test_service_implementations.py::TestInterfaceCompliance::test_all_llm_services_implement_interface PASSED [  7%]
tests/integration/services/test_service_implementations.py::TestInterfaceCompliance::test_all_embedding_services_implement_interface PASSED [  7%]
tests/integration/services/test_service_implementations.py::TestInterfaceCompliance::test_all_reranking_services_implement_interface PASSED [  8%]
tests/integration/services/test_service_implementations.py::TestInterfaceCompliance::test_all_graph_services_implement_interface PASSED [  8%]
tests/integration/services/test_service_implementations.py::TestInterfaceCompliance::test_all_database_services_implement_interface PASSED [  9%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_keyword_expansion_real_llm PASSED [  9%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_query_reformulation PASSED [ 10%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_question_generation PASSED [ 10%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_hyde_expansion PASSED [ 11%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_multi_query_generation PASSED [ 11%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_expansion_performance PASSED [ 11%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_cache_functionality FAILED [ 12%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_ab_testing_functionality PASSED [ 12%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_domain_context PASSED [ 13%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_error_handling_fallback PASSED [ 13%]
tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_stats_tracking PASSED [ 14%]
tests/unit/strategies/agentic/test_strategy.py::test_config_defaults PASSED [ 14%]
tests/unit/strategies/agentic/test_strategy.py::test_config_custom_values PASSED [ 15%]
tests/unit/strategies/agentic/test_strategy.py::test_config_validation PASSED [ 15%]
tests/unit/strategies/agentic/test_strategy.py::test_strategy_initialization FAILED [ 16%]
tests/unit/strategies/agentic/test_strategy.py::test_strategy_initialization_with_config FAILED [ 16%]
tests/unit/strategies/agentic/test_strategy.py::test_strategy_retrieve FAILED [ 17%]
tests/unit/strategies/agentic/test_strategy.py::test_strategy_retrieve_with_query_analysis FAILED [ 17%]
tests/unit/strategies/agentic/test_strategy.py::test_strategy_fallback_on_error FAILED [ 18%]
tests/unit/strategies/agentic/test_strategy.py::test_strategy_no_fallback_raises_error FAILED [ 18%]
tests/unit/strategies/agentic/test_strategy.py::test_strategy_get_stats FAILED [ 19%]
tests/unit/strategies/agentic/test_strategy.py::test_strategy_top_k_limit FAILED [ 19%]
tests/unit/documentation/test_links.py::TestDocumentationLinks::test_no_broken_internal_links FAILED [ 20%]
tests/unit/documentation/test_links.py::TestDocumentationLinks::test_all_diagrams_valid FAILED [ 20%]
tests/unit/documentation/test_links.py::TestDocumentationLinks::test_no_todo_links FAILED [ 21%]
tests/unit/documentation/test_links.py::TestDocumentationLinks::test_external_links_valid SKIPPED [ 21%]
tests/unit/documentation/test_code_examples.py::TestCodeExamples::test_all_code_examples_have_valid_syntax FAILED [ 22%]
tests/unit/documentation/test_code_examples.py::TestCodeExamples::test_strategy_examples_have_imports PASSED [ 22%]
tests/unit/documentation/test_code_examples.py::TestCodeExamples::test_configuration_examples_valid SKIPPED [ 22%]
tests/unit/documentation/test_code_examples.py::TestCodeExamples::test_quick_start_example_complete PASSED [ 23%]
tests/unit/documentation/test_code_examples.py::TestCodeExamples::test_no_placeholder_code FAILED [ 23%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_command_help PASSED [ 24%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_all_strategies_consistent PASSED [ 24%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_strategies_with_warnings PASSED [ 25%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_type_filter_indexing PASSED [ 25%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_type_filter_retrieval PASSED [ 26%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_invalid_type_filter PASSED [ 26%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_strategy_filter PASSED [ 27%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_verbose_mode PASSED [ 27%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_config_file_loading FAILED [ 28%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_system_error_returns_exit_code_1 PASSED [ 28%]
tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_strategies_with_errors PASSED [ 29%]
tests/unit/cli/test_repl_command.py::TestREPLCommand::test_repl_start PASSED [ 29%]
tests/unit/cli/test_repl_command.py::TestREPLCommand::test_repl_with_config PASSED [ 30%]
tests/unit/cli/test_repl_command.py::TestREPLSession::test_repl_session_init FAILED [ 30%]
tests/unit/cli/test_repl_command.py::TestREPLSession::test_repl_set_command PASSED [ 31%]
tests/unit/services/test_interfaces.py::test_illm_service_requires_implementation PASSED [ 31%]
tests/unit/services/test_interfaces.py::test_illm_service_requires_complete_method PASSED [ 32%]
tests/unit/services/test_interfaces.py::test_illm_service_requires_stream_complete_method PASSED [ 32%]
tests/unit/services/test_interfaces.py::test_illm_service_mock_implementation PASSED [ 33%]
tests/unit/services/test_interfaces.py::test_illm_service_has_docstring PASSED [ 33%]
tests/unit/services/test_interfaces.py::test_iembedding_service_requires_implementation PASSED [ 33%]
tests/unit/services/test_interfaces.py::test_iembedding_service_requires_embed_method PASSED [ 34%]
tests/unit/services/test_interfaces.py::test_iembedding_service_mock_implementation PASSED [ 34%]
tests/unit/services/test_interfaces.py::test_iembedding_service_has_docstring PASSED [ 35%]
tests/unit/services/test_interfaces.py::test_igraph_service_requires_implementation PASSED [ 35%]
tests/unit/services/test_interfaces.py::test_igraph_service_requires_create_node_method PASSED [ 36%]
tests/unit/services/test_interfaces.py::test_igraph_service_mock_implementation PASSED [ 36%]
tests/unit/services/test_interfaces.py::test_igraph_service_has_docstring PASSED [ 37%]
tests/unit/services/test_interfaces.py::test_ireranking_service_requires_implementation PASSED [ 37%]
tests/unit/services/test_interfaces.py::test_ireranking_service_mock_implementation PASSED [ 38%]
tests/unit/services/test_interfaces.py::test_ireranking_service_has_docstring PASSED [ 38%]
tests/unit/services/test_interfaces.py::test_idatabase_service_requires_implementation PASSED [ 39%]
tests/unit/services/test_interfaces.py::test_idatabase_service_requires_store_chunks_method PASSED [ 39%]
tests/unit/services/test_interfaces.py::test_idatabase_service_mock_implementation FAILED [ 40%]
tests/unit/services/test_interfaces.py::test_idatabase_service_has_docstring PASSED [ 40%]
tests/unit/services/test_interfaces.py::test_all_interfaces_have_type_hints PASSED [ 41%]
tests/unit/services/test_database_service.py::test_service_initialization PASSED [ 41%]
tests/unit/services/test_database_service.py::test_ensure_table FAILED   [ 42%]
tests/unit/services/test_database_service.py::test_store_chunks FAILED   [ 42%]
tests/unit/services/test_database_service.py::test_store_empty_chunks PASSED [ 43%]
tests/unit/services/test_database_service.py::test_search_chunks FAILED  [ 43%]
tests/unit/services/test_database_service.py::test_get_chunk FAILED      [ 44%]
tests/unit/services/test_database_service.py::test_get_chunk_not_found FAILED [ 44%]
tests/unit/services/test_database_service.py::test_get_chunks_for_documents FAILED [ 44%]
tests/unit/services/test_database_service.py::test_close FAILED          [ 45%]
tests/unit/services/test_database_service.py::test_context_manager FAILED [ 45%]
tests/unit/documentation/test_documentation_completeness.py::TestDocumentationCompleteness::test_required_doc_files_exist PASSED [ 46%]
tests/unit/documentation/test_documentation_completeness.py::TestDocumentationCompleteness::test_all_strategies_documented PASSED [ 46%]
tests/unit/documentation/test_documentation_completeness.py::TestDocumentationCompleteness::test_all_public_classes_documented PASSED [ 47%]
tests/unit/documentation/test_documentation_completeness.py::TestDocumentationCompleteness::test_all_public_methods_documented PASSED [ 47%]
tests/unit/documentation/test_documentation_completeness.py::TestDocumentationCompleteness::test_documentation_completeness_score PASSED [ 48%]
tests/unit/documentation/test_documentation_completeness.py::TestDocumentationCompleteness::test_mkdocs_config_valid FAILED [ 48%]
tests/unit/documentation/test_documentation_completeness.py::TestDocumentationCompleteness::test_readme_exists PASSED [ 49%]
tests/unit/documentation/test_documentation_completeness.py::TestDocumentationCompleteness::test_changelog_exists PASSED [ 49%]
tests/unit/database/test_migrations.py::TestAlembicMigrations::test_migration_upgrade_to_head PASSED [ 50%]
tests/unit/database/test_migrations.py::TestAlembicMigrations::test_migration_downgrade FAILED [ 50%]
tests/unit/database/test_migrations.py::TestAlembicMigrations::test_migration_history PASSED [ 51%]
tests/unit/database/test_migrations.py::TestAlembicMigrations::test_migration_idempotency PASSED [ 51%]
tests/unit/database/test_migrations.py::TestAlembicMigrations::test_get_current_version PASSED [ 52%]
tests/unit/database/test_migrations.py::TestAlembicMigrations::test_migration_creates_tables FAILED [ 52%]
tests/unit/database/test_migrations.py::TestAlembicMigrations::test_migration_creates_indexes FAILED [ 53%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryCreate::test_create_chunk_success PASSED [ 53%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryCreate::test_create_chunk_with_embedding PASSED [ 54%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryCreate::test_create_chunk_with_metadata PASSED [ 54%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryCreate::test_create_chunk_database_error PASSED [ 55%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryCreate::test_bulk_create_chunks PASSED [ 55%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryCreate::test_bulk_create_database_error PASSED [ 55%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryRead::test_get_by_id_found PASSED [ 56%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryRead::test_get_by_id_not_found PASSED [ 56%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryRead::test_get_by_id_database_error PASSED [ 57%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryRead::test_get_by_document PASSED [ 57%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryRead::test_count_by_document PASSED [ 58%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryUpdate::test_update_chunk_success PASSED [ 58%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryUpdate::test_update_chunk_not_found PASSED [ 59%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryUpdate::test_update_embedding PASSED [ 59%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryUpdate::test_update_embedding_not_found PASSED [ 60%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryUpdate::test_bulk_update_embeddings PASSED [ 60%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryUpdate::test_bulk_update_embeddings_database_error PASSED [ 61%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryDelete::test_delete_chunk_success PASSED [ 61%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryDelete::test_delete_chunk_not_found PASSED [ 62%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryDelete::test_delete_by_document PASSED [ 62%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryDelete::test_delete_database_error PASSED [ 63%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_validation_empty_embedding PASSED [ 63%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_validation_invalid_top_k PASSED [ 64%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_success PASSED [ 64%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_with_threshold PASSED [ 65%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_database_error PASSED [ 65%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_with_filter_validation PASSED [ 66%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_with_filter_success FAILED [ 66%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_with_metadata_success PASSED [ 66%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_with_metadata_validation PASSED [ 67%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryEdgeCases::test_create_chunk_without_embedding PASSED [ 67%]
tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryEdgeCases::test_update_with_metadata_attribute PASSED [ 68%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_initialization PASSED [ 68%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_initialization_with_custom_config PASSED [ 69%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_get_embeddings_single_text PASSED [ 69%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_get_embeddings_multiple_texts PASSED [ 70%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_get_embeddings_empty_list PASSED [ 70%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_embedding_normalization PASSED [ 71%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_tokenization_with_tiktoken FAILED [ 71%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_tokenization_simple_fallback FAILED [ 72%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_get_dimensions PASSED [ 72%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_get_max_batch_size PASSED [ 73%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_get_model_name PASSED [ 73%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_calculate_cost PASSED [ 74%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_known_models PASSED [ 74%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_missing_onnx_runtime PASSED [ 75%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_missing_huggingface_hub PASSED [ 75%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_model_download_failure PASSED [ 76%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_session_creation_failure PASSED [ 76%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_embedding_error_handling PASSED [ 77%]
tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_batch_processing PASSED [ 77%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_provider_not_available_raises_error PASSED [ 77%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_provider_initialization PASSED [ 78%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_get_embeddings PASSED [ 78%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_calculate_cost_is_zero PASSED [ 79%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_known_model_dimensions PASSED [ 79%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_unknown_model_uses_output_shape PASSED [ 80%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_custom_batch_size PASSED [ 80%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_model_loading_failure PASSED [ 81%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_get_model_name PASSED [ 81%]
tests/unit/services/embedding/test_onnx_local_provider.py::test_mean_pooling FAILED [ 82%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_document_embedding_basic PASSED [ 82%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_token_embeddings_extracted PASSED [ 83%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_mean_pooling PASSED [ 83%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_mean_pooling_with_mask PASSED [ 84%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_long_document_truncation FAILED [ 84%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_batch_processing PASSED [ 85%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_embedding_dimensions_consistent FAILED [ 85%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_model_name_stored PASSED [ 86%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_chunk_embeddings PASSED [ 86%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_pool_embeddings_mean PASSED [ 87%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_pool_embeddings_max PASSED [ 87%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_pool_embeddings_first PASSED [ 88%]
tests/unit/strategies/late_chunking/test_document_embedder.py::test_decode_tokens PASSED [ 88%]
tests/unit/test_pipeline.py::test_pipeline_can_be_created PASSED         [ 88%]
tests/unit/test_pipeline.py::test_pipeline_add_stage FAILED              [ 89%]
tests/unit/test_pipeline.py::test_pipeline_chaining FAILED               [ 89%]
tests/unit/test_pipeline.py::test_sequential_execution_order FAILED      [ 90%]
tests/unit/test_pipeline.py::test_sequential_execution_collects_results FAILED [ 90%]
tests/unit/test_pipeline.py::test_parallel_execution FAILED              [ 91%]
tests/unit/test_pipeline.py::test_strategy_error_caught FAILED           [ 91%]
tests/unit/test_pipeline.py::test_fallback_strategy_executed FAILED      [ 92%]
tests/unit/test_pipeline.py::test_duplicate_results_removed FAILED       [ 92%]
tests/unit/test_pipeline.py::test_results_sorted_by_score FAILED         [ 93%]
tests/unit/test_pipeline.py::test_performance_metrics_collected FAILED   [ 93%]
tests/unit/test_pipeline.py::test_from_config_creates_pipeline FAILED    [ 94%]
tests/unit/test_pipeline.py::test_cascade_mode_not_implemented FAILED    [ 94%]
tests/unit/test_pipeline.py::test_cascade_mode_not_implemented_async FAILED [ 95%]
tests/unit/test_pipeline.py::test_required_stage_failure_raises_exception FAILED [ 95%]
tests/unit/test_pipeline.py::test_required_stage_failure_raises_exception_async FAILED [ 96%]
tests/unit/test_pipeline.py::test_fallback_failure_when_required FAILED  [ 96%]
tests/unit/test_pipeline.py::test_fallback_failure_when_required_async FAILED [ 97%]
tests/unit/test_pipeline.py::test_parallel_required_stage_failure FAILED [ 97%]
tests/unit/test_pipeline.py::test_parallel_required_fallback_failure FAILED [ 98%]
tests/unit/test_pipeline.py::test_non_required_fallback_failure_continues FAILED [ 98%]
tests/unit/test_pipeline.py::test_non_required_fallback_failure_continues_async FAILED [ 99%]
tests/unit/test_pipeline.py::test_parallel_non_required_fallback_success FAILED [ 99%]
tests/unit/test_pipeline.py::test_parallel_non_required_both_fail FAILED [100%]

=================================== FAILURES ===================================
__ TestDatabaseServices.test_postgresql_database_service_basic_functionality ___

self = <tests.integration.services.test_service_implementations.TestDatabaseServices object at 0x7422a45ee9f0>

    @pytest.mark.asyncio
    @pytest.mark.skipif(
        not hasattr(PostgresqlDatabaseService, '__init__'),
        reason="asyncpg package not installed"
    )
    async def test_postgresql_database_service_basic_functionality(self):
        """Test basic database operations with mocked pool."""
        try:
            import asyncpg  # noqa: F401
        except ImportError:
            pytest.skip("asyncpg package not installed")
    
        with patch('asyncpg.create_pool') as mock_create_pool:
            # Setup mocks
            mock_pool = AsyncMock()
            mock_create_pool.return_value = mock_pool
    
            mock_conn = AsyncMock()
            mock_pool.acquire.return_value.__aenter__.return_value = mock_conn
    
            # Create service
            service = PostgresqlDatabaseService(
                host="localhost",
                database="test_db",
                user="postgres",
                password="password"
            )
    
            # Test store_chunks (just verify it doesn't crash)
            chunks = [{
                "chunk_id": "test_1",
                "text": "Test content",
                "embedding": [0.1, 0.2, 0.3],
                "metadata": {}
            }]
>           await service.store_chunks(chunks)

tests/integration/services/test_service_implementations.py:217: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/database/postgres.py:155: in store_chunks
    pool = await self._get_pool()
           ^^^^^^^^^^^^^^^^^^^^^^
rag_factory/services/database/postgres.py:98: in _get_pool
    self._pool = await asyncpg.create_pool(
venv/lib/python3.12/site-packages/asyncpg/pool.py:439: in _async__init__
    await self._initialize()
venv/lib/python3.12/site-packages/asyncpg/pool.py:466: in _initialize
    await first_ch.connect()
venv/lib/python3.12/site-packages/asyncpg/pool.py:153: in connect
    self._con = await self._pool._get_new_connection()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/pool.py:538: in _get_new_connection
    con = await self._connect(
venv/lib/python3.12/site-packages/asyncpg/connection.py:2443: in connect
    return await connect_utils._connect(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1249: in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1218: in _connect
    conn = await _connect_addr(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1054: in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1099: in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:969: in _create_ssl_connection
    tr, pr = await loop.create_connection(
/usr/lib/python3.12/asyncio/base_events.py:1122: in create_connection
    raise exceptions[0]
/usr/lib/python3.12/asyncio/base_events.py:1104: in create_connection
    sock = await self._connect_sock(
/usr/lib/python3.12/asyncio/base_events.py:1007: in _connect_sock
    await self.sock_connect(sock, address)
/usr/lib/python3.12/asyncio/selector_events.py:651: in sock_connect
    return await fut
           ^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>
fut = None, sock = <socket.socket [closed] fd=-1, family=2, type=1, proto=6>
address = ('127.0.0.1', 5432)

    def _sock_connect_cb(self, fut, sock, address):
        if fut.done():
            return
    
        try:
            err = sock.getsockopt(socket.SOL_SOCKET, socket.SO_ERROR)
            if err != 0:
                # Jump to any except clause below.
>               raise OSError(err, f'Connect call failed {address}')
E               ConnectionRefusedError: [Errno 111] Connect call failed ('127.0.0.1', 5432)

/usr/lib/python3.12/asyncio/selector_events.py:691: ConnectionRefusedError
____________ TestQueryExpansionIntegration.test_cache_functionality ____________

self = <tests.integration.strategies.test_query_expansion_integration.TestQueryExpansionIntegration object at 0x7422a45ed2e0>
llm_service_from_env = <rag_factory.services.llm.service.LLMService object at 0x7422a3fdaf60>

    def test_cache_functionality(self, llm_service_from_env):
        """Test that caching works correctly."""
        expansion_config = ExpansionConfig(
            strategy=ExpansionStrategy.KEYWORD,
            enable_cache=True
        )
    
        service = QueryExpanderService(expansion_config, llm_service_from_env)
    
        query = "neural networks"
    
        # First call - cache miss
        result1 = service.expand(query)
        assert result1.cache_hit is False
        time1 = result1.execution_time_ms
    
        # Second call - cache hit
        result2 = service.expand(query)
        assert result2.cache_hit is True
        time2 = result2.execution_time_ms
    
        # Cached call should be much faster
>       assert time2 < time1
E       assert 250.97107887268066 < 250.97107887268066

tests/integration/strategies/test_query_expansion_integration.py:159: AssertionError
_________________________ test_strategy_initialization _________________________

mock_llm_service = <Mock id='127692105552944'>
mock_embedding_service = <Mock id='127692105771168'>
mock_chunk_repository = <Mock id='127692105762912'>
mock_document_repository = <Mock id='127692105762528'>

    def test_strategy_initialization(
        mock_llm_service,
        mock_embedding_service,
        mock_chunk_repository,
        mock_document_repository
    ):
        """Test strategy initialization."""
>       strategy = AgenticRAGStrategy(
            mock_llm_service,
            mock_embedding_service,
            mock_chunk_repository,
            mock_document_repository
        )
E       TypeError: AgenticRAGStrategy.__init__() takes 3 positional arguments but 5 were given

tests/unit/strategies/agentic/test_strategy.py:92: TypeError
___________________ test_strategy_initialization_with_config ___________________

mock_llm_service = <Mock id='127692105775680'>
mock_embedding_service = <Mock id='127692105776112'>
mock_chunk_repository = <Mock id='127692105774912'>
mock_document_repository = <Mock id='127692105775392'>

    def test_strategy_initialization_with_config(
        mock_llm_service,
        mock_embedding_service,
        mock_chunk_repository,
        mock_document_repository
    ):
        """Test strategy initialization with config."""
        config = {
            "max_iterations": 5,
            "enable_query_analysis": False,
            "enabled_tools": ["semantic_search", "metadata_search"]
        }
    
>       strategy = AgenticRAGStrategy(
            mock_llm_service,
            mock_embedding_service,
            mock_chunk_repository,
            mock_document_repository,
            config=config
        )
E       TypeError: AgenticRAGStrategy.__init__() got multiple values for argument 'config'

tests/unit/strategies/agentic/test_strategy.py:117: TypeError
____________________________ test_strategy_retrieve ____________________________

mock_llm_service = <Mock id='127692105767280'>
mock_embedding_service = <Mock id='127692105762864'>
mock_chunk_repository = <Mock id='127692105765744'>
mock_document_repository = <Mock id='127692105765360'>

    def test_strategy_retrieve(
        mock_llm_service,
        mock_embedding_service,
        mock_chunk_repository,
        mock_document_repository
    ):
        """Test strategy retrieve method."""
>       strategy = AgenticRAGStrategy(
            mock_llm_service,
            mock_embedding_service,
            mock_chunk_repository,
            mock_document_repository
        )
E       TypeError: AgenticRAGStrategy.__init__() takes 3 positional arguments but 5 were given

tests/unit/strategies/agentic/test_strategy.py:136: TypeError
__________________ test_strategy_retrieve_with_query_analysis __________________

mock_llm_service = <Mock id='127692105762672'>
mock_embedding_service = <Mock id='127692105767616'>
mock_chunk_repository = <Mock id='127692105767472'>
mock_document_repository = <Mock id='127692105763632'>

    def test_strategy_retrieve_with_query_analysis(
        mock_llm_service,
        mock_embedding_service,
        mock_chunk_repository,
        mock_document_repository
    ):
        """Test strategy retrieve with query analysis."""
        config = {"enable_query_analysis": True}
>       strategy = AgenticRAGStrategy(
            mock_llm_service,
            mock_embedding_service,
            mock_chunk_repository,
            mock_document_repository,
            config=config
        )
E       TypeError: AgenticRAGStrategy.__init__() got multiple values for argument 'config'

tests/unit/strategies/agentic/test_strategy.py:173: TypeError
_______________________ test_strategy_fallback_on_error ________________________

mock_llm_service = <Mock id='127692105770160'>
mock_embedding_service = <Mock id='127692105773232'>
mock_chunk_repository = <Mock id='127692105771264'>
mock_document_repository = <Mock id='127692105769344'>

    def test_strategy_fallback_on_error(
        mock_llm_service,
        mock_embedding_service,
        mock_chunk_repository,
        mock_document_repository
    ):
        """Test strategy falls back to semantic search on error."""
        config = {"fallback_to_semantic": True}
>       strategy = AgenticRAGStrategy(
            mock_llm_service,
            mock_embedding_service,
            mock_chunk_repository,
            mock_document_repository,
            config=config
        )
E       TypeError: AgenticRAGStrategy.__init__() got multiple values for argument 'config'

tests/unit/strategies/agentic/test_strategy.py:202: TypeError
____________________ test_strategy_no_fallback_raises_error ____________________

mock_llm_service = <Mock id='127692105562688'>
mock_embedding_service = <Mock id='127692105553424'>
mock_chunk_repository = <Mock id='127692105552656'>
mock_document_repository = <Mock id='127692105551936'>

    def test_strategy_no_fallback_raises_error(
        mock_llm_service,
        mock_embedding_service,
        mock_chunk_repository,
        mock_document_repository
    ):
        """Test strategy raises error when fallback disabled."""
        config = {"fallback_to_semantic": False}
>       strategy = AgenticRAGStrategy(
            mock_llm_service,
            mock_embedding_service,
            mock_chunk_repository,
            mock_document_repository,
            config=config
        )
E       TypeError: AgenticRAGStrategy.__init__() got multiple values for argument 'config'

tests/unit/strategies/agentic/test_strategy.py:226: TypeError
___________________________ test_strategy_get_stats ____________________________

mock_llm_service = <Mock id='127692105558992'>
mock_embedding_service = <Mock id='127692105560624'>
mock_chunk_repository = <Mock id='127692105553904'>
mock_document_repository = <Mock id='127692105555440'>

    def test_strategy_get_stats(
        mock_llm_service,
        mock_embedding_service,
        mock_chunk_repository,
        mock_document_repository
    ):
        """Test strategy get_stats method."""
>       strategy = AgenticRAGStrategy(
            mock_llm_service,
            mock_embedding_service,
            mock_chunk_repository,
            mock_document_repository
        )
E       TypeError: AgenticRAGStrategy.__init__() takes 3 positional arguments but 5 were given

tests/unit/strategies/agentic/test_strategy.py:247: TypeError
__________________________ test_strategy_top_k_limit ___________________________

mock_llm_service = <Mock id='127692135559296'>
mock_embedding_service = <Mock id='127692135550080'>
mock_chunk_repository = <Mock id='127692135395984'>
mock_document_repository = <Mock id='127692129021600'>

    def test_strategy_top_k_limit(
        mock_llm_service,
        mock_embedding_service,
        mock_chunk_repository,
        mock_document_repository
    ):
        """Test strategy respects top_k limit."""
>       strategy = AgenticRAGStrategy(
            mock_llm_service,
            mock_embedding_service,
            mock_chunk_repository,
            mock_document_repository
        )
E       TypeError: AgenticRAGStrategy.__init__() takes 3 positional arguments but 5 were given

tests/unit/strategies/agentic/test_strategy.py:270: TypeError
_____________ TestDocumentationLinks.test_no_broken_internal_links _____________

self = <test_links.TestDocumentationLinks object at 0x7422a44578c0>
docs_root = PosixPath('/mnt/MCPProyects/ragTools/docs')

    def test_no_broken_internal_links(self, docs_root):
        """Test that all internal links are valid."""
        broken_links = []
    
        for md_file in docs_root.rglob("*.md"):
>           links = self.extract_links(md_file)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/documentation/test_links.py:39: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/unit/documentation/test_links.py:27: in extract_links
    content = f.read()
              ^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <encodings.utf_8.IncrementalDecoder object at 0x7422a292f740>
input = b'# Story 5.2: Implement Hierarchical RAG Strategy\n\n**Story ID:** 5.2\n**Epic:** Epic 5 - Agentic & Advanced Retriev...n10. **Use Cases**: Best for technical docs, books, long-form content. Less useful for short documents or chat logs.\n'
final = True

>   ???
E   UnicodeDecodeError: 'utf-8' codec can't decode byte 0x92 in position 579: invalid start byte

<frozen codecs>:322: UnicodeDecodeError
________________ TestDocumentationLinks.test_all_diagrams_valid ________________

self = <test_links.TestDocumentationLinks object at 0x7422a4456f60>
docs_root = PosixPath('/mnt/MCPProyects/ragTools/docs')

    def test_all_diagrams_valid(self, docs_root):
        """Test that all mermaid diagrams have valid syntax."""
        errors = []
    
        for md_file in docs_root.rglob("*.md"):
            if not md_file.exists():
                continue
    
            with open(md_file, encoding='utf-8') as f:
>               content = f.read()
                          ^^^^^^^^

tests/unit/documentation/test_links.py:72: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <encodings.utf_8.IncrementalDecoder object at 0x7422a29af740>
input = b'# Story 5.2: Implement Hierarchical RAG Strategy\n\n**Story ID:** 5.2\n**Epic:** Epic 5 - Agentic & Advanced Retriev...n10. **Use Cases**: Best for technical docs, books, long-form content. Less useful for short documents or chat logs.\n'
final = True

>   ???
E   UnicodeDecodeError: 'utf-8' codec can't decode byte 0x92 in position 579: invalid start byte

<frozen codecs>:322: UnicodeDecodeError
__________________ TestDocumentationLinks.test_no_todo_links ___________________

self = <test_links.TestDocumentationLinks object at 0x7422a4456840>
docs_root = PosixPath('/mnt/MCPProyects/ragTools/docs')

    def test_no_todo_links(self, docs_root):
        """Test that there are no TODO or placeholder links."""
        todo_patterns = ["TODO", "FIXME", "example.com", "yourusername"]
    
        files_with_todos = []
    
        for md_file in docs_root.rglob("*.md"):
            if not md_file.exists():
                continue
    
>           links = self.extract_links(md_file)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/documentation/test_links.py:109: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/unit/documentation/test_links.py:27: in extract_links
    content = f.read()
              ^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <encodings.utf_8.IncrementalDecoder object at 0x7422a29acdd0>
input = b'# Story 5.2: Implement Hierarchical RAG Strategy\n\n**Story ID:** 5.2\n**Epic:** Epic 5 - Agentic & Advanced Retriev...n10. **Use Cases**: Best for technical docs, books, long-form content. Less useful for short documents or chat logs.\n'
final = True

>   ???
E   UnicodeDecodeError: 'utf-8' codec can't decode byte 0x92 in position 579: invalid start byte

<frozen codecs>:322: UnicodeDecodeError
__________ TestCodeExamples.test_all_code_examples_have_valid_syntax ___________

self = <test_code_examples.TestCodeExamples object at 0x7422a4455520>
docs_root = PosixPath('/mnt/MCPProyects/ragTools/docs')

    def test_all_code_examples_have_valid_syntax(self, docs_root):
        """Test that all Python code examples have valid syntax."""
        errors = []
    
        for md_file in docs_root.rglob("*.md"):
>           examples = self.extract_python_examples(md_file)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/documentation/test_code_examples.py:40: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/unit/documentation/test_code_examples.py:28: in extract_python_examples
    content = f.read()
              ^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <encodings.utf_8.IncrementalDecoder object at 0x7422a29ac6e0>
input = b'# Story 5.2: Implement Hierarchical RAG Strategy\n\n**Story ID:** 5.2\n**Epic:** Epic 5 - Agentic & Advanced Retriev...n10. **Use Cases**: Best for technical docs, books, long-form content. Less useful for short documents or chat logs.\n'
final = True

>   ???
E   UnicodeDecodeError: 'utf-8' codec can't decode byte 0x92 in position 579: invalid start byte

<frozen codecs>:322: UnicodeDecodeError
__________________ TestCodeExamples.test_no_placeholder_code ___________________

self = <test_code_examples.TestCodeExamples object at 0x7422a44802c0>
docs_root = PosixPath('/mnt/MCPProyects/ragTools/docs')

    def test_no_placeholder_code(self, docs_root):
        """Test that code examples don't contain placeholder comments."""
        placeholders = ["# TODO", "# FIXME", "# Implementation", "pass  # Your"]
    
        files_with_placeholders = []
    
        for md_file in docs_root.rglob("*.md"):
>           examples = self.extract_python_examples(md_file)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/documentation/test_code_examples.py:125: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/unit/documentation/test_code_examples.py:28: in extract_python_examples
    content = f.read()
              ^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <encodings.utf_8.IncrementalDecoder object at 0x7422a297b4a0>
input = b'# Story 5.2: Implement Hierarchical RAG Strategy\n\n**Story ID:** 5.2\n**Epic:** Epic 5 - Agentic & Advanced Retriev...n10. **Use Cases**: Best for technical docs, books, long-form content. Less useful for short documents or chat logs.\n'
final = True

>   ???
E   UnicodeDecodeError: 'utf-8' codec can't decode byte 0x92 in position 579: invalid start byte

<frozen codecs>:322: UnicodeDecodeError
_____________ TestCheckConsistencyCommand.test_config_file_loading _____________

self = <tests.unit.cli.test_check_consistency_command.TestCheckConsistencyCommand object at 0x7422a44837d0>
mock_factory_cls = <MagicMock name='RAGFactory' id='127692095212144'>
mock_validate_config = <MagicMock name='validate_config_file' id='127692099476928'>
cli_runner = <typer.testing.CliRunner object at 0x7422a1f9c230>
mock_factory = <Mock name='RAGFactory()' id='127692095212336'>

    @patch("rag_factory.cli.commands.check_consistency.validate_config_file")
    @patch("rag_factory.cli.commands.check_consistency.RAGFactory")
    def test_config_file_loading(
        self,
        mock_factory_cls,
        mock_validate_config,
        cli_runner,
        mock_factory
    ):
        """Test config file is loaded when provided."""
        # Setup mocks
        mock_validate_config.return_value = {"some": "config"}
        mock_factory_cls.return_value = mock_factory
        mock_factory.check_all_strategies = Mock(return_value={})
    
        # Run command with config
        result = cli_runner.invoke(
            app,
            ["check-consistency", "--config", "config.yaml"]
        )
    
        # Verify config was loaded
>       mock_validate_config.assert_called_once_with("config.yaml")

tests/unit/cli/test_check_consistency_command.py:220: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='validate_config_file' id='127692099476928'>
args = ('config.yaml',), kwargs = {}
msg = "Expected 'validate_config_file' to be called once. Called 0 times."

    def assert_called_once_with(self, /, *args, **kwargs):
        """assert that the mock was called exactly once and that that call was
        with the specified arguments."""
        if not self.call_count == 1:
            msg = ("Expected '%s' to be called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'validate_config_file' to be called once. Called 0 times.

/usr/lib/python3.12/unittest/mock.py:955: AssertionError
____________________ TestREPLSession.test_repl_session_init ____________________

args = (<tests.unit.cli.test_repl_command.TestREPLSession object at 0x7422a4482c00>,)
keywargs = {}

    @wraps(func)
    def patched(*args, **keywargs):
>       with self.decoration_helper(patched,
                                    args,
                                    keywargs) as (newargs, newkeywargs):

/usr/lib/python3.12/unittest/mock.py:1387: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib/python3.12/unittest/mock.py:1369: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7422a457f260>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'rag_factory.cli.commands.repl' from '/mnt/MCPProyects/ragTools/rag_factory/cli/commands/repl.py'> does not have the attribute 'validate_config_file'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
__________________ test_idatabase_service_mock_implementation __________________

    @pytest.mark.asyncio
    async def test_idatabase_service_mock_implementation():
        """Test that complete IDatabaseService implementation works."""
    
        class MockDatabaseService(IDatabaseService):
            def __init__(self):
                self.chunks = {}
    
            async def store_chunks(self, chunks: List[Dict[str, Any]]) -> None:
                for chunk in chunks:
                    chunk_id = chunk.get("id", f"chunk_{len(self.chunks)}")
                    self.chunks[chunk_id] = chunk
    
            async def search_chunks(
                self, query_embedding: List[float], top_k: int = 10
            ) -> List[Dict[str, Any]]:
                # Simple mock: return first top_k chunks
                return list(self.chunks.values())[:top_k]
    
            async def get_chunk(self, chunk_id: str) -> Dict[str, Any]:
                return self.chunks.get(chunk_id, {})
    
>       service = MockDatabaseService()
                  ^^^^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class MockDatabaseService without an implementation for abstract methods 'get_chunks_for_documents', 'store_chunks_with_hierarchy'

tests/unit/services/test_interfaces.py:371: TypeError
______________________________ test_ensure_table _______________________________

service = <rag_factory.services.database.postgres.PostgresqlDatabaseService object at 0x7422a23ac470>
mock_pool = (<AsyncMock id='127692074457312'>, <AsyncMock name='mock.acquire().__aenter__()' id='127692074466192'>)

    @pytest.mark.asyncio
    async def test_ensure_table(service, mock_pool):
        """Test table creation."""
        pool, conn = mock_pool
    
        # Trigger pool creation which calls ensure_table
>       await service._get_pool()

tests/unit/services/test_database_service.py:58: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/database/postgres.py:98: in _get_pool
    self._pool = await asyncpg.create_pool(
venv/lib/python3.12/site-packages/asyncpg/pool.py:439: in _async__init__
    await self._initialize()
venv/lib/python3.12/site-packages/asyncpg/pool.py:466: in _initialize
    await first_ch.connect()
venv/lib/python3.12/site-packages/asyncpg/pool.py:153: in connect
    self._con = await self._pool._get_new_connection()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/pool.py:538: in _get_new_connection
    con = await self._connect(
venv/lib/python3.12/site-packages/asyncpg/connection.py:2443: in connect
    return await connect_utils._connect(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1249: in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1218: in _connect
    conn = await _connect_addr(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1054: in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1099: in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:969: in _create_ssl_connection
    tr, pr = await loop.create_connection(
/usr/lib/python3.12/asyncio/base_events.py:1122: in create_connection
    raise exceptions[0]
/usr/lib/python3.12/asyncio/base_events.py:1104: in create_connection
    sock = await self._connect_sock(
/usr/lib/python3.12/asyncio/base_events.py:1007: in _connect_sock
    await self.sock_connect(sock, address)
/usr/lib/python3.12/asyncio/selector_events.py:651: in sock_connect
    return await fut
           ^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>
fut = None, sock = <socket.socket [closed] fd=-1, family=2, type=1, proto=6>
address = ('127.0.0.1', 5432)

    def _sock_connect_cb(self, fut, sock, address):
        if fut.done():
            return
    
        try:
            err = sock.getsockopt(socket.SOL_SOCKET, socket.SO_ERROR)
            if err != 0:
                # Jump to any except clause below.
>               raise OSError(err, f'Connect call failed {address}')
E               ConnectionRefusedError: [Errno 111] Connect call failed ('127.0.0.1', 5432)

/usr/lib/python3.12/asyncio/selector_events.py:691: ConnectionRefusedError
______________________________ test_store_chunks _______________________________

service = <rag_factory.services.database.postgres.PostgresqlDatabaseService object at 0x7422a1ff9c10>
mock_pool = (<AsyncMock id='127692133722944'>, <AsyncMock name='mock.acquire().__aenter__()' id='127692133901968'>)

    @pytest.mark.asyncio
    async def test_store_chunks(service, mock_pool):
        """Test storing chunks."""
        pool, conn = mock_pool
    
        chunks = [
            {
                "chunk_id": "1",
                "text": "Hello",
                "embedding": [0.1, 0.2, 0.3],
                "metadata": {"source": "doc1"}
            }
        ]
    
>       await service.store_chunks(chunks)

tests/unit/services/test_database_service.py:81: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/database/postgres.py:155: in store_chunks
    pool = await self._get_pool()
           ^^^^^^^^^^^^^^^^^^^^^^
rag_factory/services/database/postgres.py:98: in _get_pool
    self._pool = await asyncpg.create_pool(
venv/lib/python3.12/site-packages/asyncpg/pool.py:439: in _async__init__
    await self._initialize()
venv/lib/python3.12/site-packages/asyncpg/pool.py:466: in _initialize
    await first_ch.connect()
venv/lib/python3.12/site-packages/asyncpg/pool.py:153: in connect
    self._con = await self._pool._get_new_connection()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/pool.py:538: in _get_new_connection
    con = await self._connect(
venv/lib/python3.12/site-packages/asyncpg/connection.py:2443: in connect
    return await connect_utils._connect(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1249: in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1218: in _connect
    conn = await _connect_addr(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1054: in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1099: in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:969: in _create_ssl_connection
    tr, pr = await loop.create_connection(
/usr/lib/python3.12/asyncio/base_events.py:1122: in create_connection
    raise exceptions[0]
/usr/lib/python3.12/asyncio/base_events.py:1104: in create_connection
    sock = await self._connect_sock(
/usr/lib/python3.12/asyncio/base_events.py:1007: in _connect_sock
    await self.sock_connect(sock, address)
/usr/lib/python3.12/asyncio/selector_events.py:651: in sock_connect
    return await fut
           ^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>
fut = None, sock = <socket.socket [closed] fd=-1, family=2, type=1, proto=6>
address = ('127.0.0.1', 5432)

    def _sock_connect_cb(self, fut, sock, address):
        if fut.done():
            return
    
        try:
            err = sock.getsockopt(socket.SOL_SOCKET, socket.SO_ERROR)
            if err != 0:
                # Jump to any except clause below.
>               raise OSError(err, f'Connect call failed {address}')
E               ConnectionRefusedError: [Errno 111] Connect call failed ('127.0.0.1', 5432)

/usr/lib/python3.12/asyncio/selector_events.py:691: ConnectionRefusedError
______________________________ test_search_chunks ______________________________

service = <rag_factory.services.database.postgres.PostgresqlDatabaseService object at 0x7422a45c14c0>
mock_pool = (<AsyncMock id='127692095215216'>, <AsyncMock name='mock.acquire().__aenter__()' id='127692095265040'>)

    @pytest.mark.asyncio
    async def test_search_chunks(service, mock_pool):
        """Test searching chunks."""
        pool, conn = mock_pool
    
        # Mock search results
        conn.fetch.return_value = [
            {
                "chunk_id": "1",
                "text": "Hello",
                "metadata": '{"source": "doc1"}',
                "similarity": 0.95
            }
        ]
    
>       results = await service.search_chunks([0.1, 0.2, 0.3], top_k=5)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/services/test_database_service.py:113: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/database/postgres.py:209: in search_chunks
    pool = await self._get_pool()
           ^^^^^^^^^^^^^^^^^^^^^^
rag_factory/services/database/postgres.py:98: in _get_pool
    self._pool = await asyncpg.create_pool(
venv/lib/python3.12/site-packages/asyncpg/pool.py:439: in _async__init__
    await self._initialize()
venv/lib/python3.12/site-packages/asyncpg/pool.py:466: in _initialize
    await first_ch.connect()
venv/lib/python3.12/site-packages/asyncpg/pool.py:153: in connect
    self._con = await self._pool._get_new_connection()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/pool.py:538: in _get_new_connection
    con = await self._connect(
venv/lib/python3.12/site-packages/asyncpg/connection.py:2443: in connect
    return await connect_utils._connect(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1249: in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1218: in _connect
    conn = await _connect_addr(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1054: in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1099: in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:969: in _create_ssl_connection
    tr, pr = await loop.create_connection(
/usr/lib/python3.12/asyncio/base_events.py:1122: in create_connection
    raise exceptions[0]
/usr/lib/python3.12/asyncio/base_events.py:1104: in create_connection
    sock = await self._connect_sock(
/usr/lib/python3.12/asyncio/base_events.py:1007: in _connect_sock
    await self.sock_connect(sock, address)
/usr/lib/python3.12/asyncio/selector_events.py:651: in sock_connect
    return await fut
           ^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>
fut = None, sock = <socket.socket [closed] fd=-1, family=2, type=1, proto=6>
address = ('127.0.0.1', 5432)

    def _sock_connect_cb(self, fut, sock, address):
        if fut.done():
            return
    
        try:
            err = sock.getsockopt(socket.SOL_SOCKET, socket.SO_ERROR)
            if err != 0:
                # Jump to any except clause below.
>               raise OSError(err, f'Connect call failed {address}')
E               ConnectionRefusedError: [Errno 111] Connect call failed ('127.0.0.1', 5432)

/usr/lib/python3.12/asyncio/selector_events.py:691: ConnectionRefusedError
________________________________ test_get_chunk ________________________________

service = <rag_factory.services.database.postgres.PostgresqlDatabaseService object at 0x7422a0bad460>
mock_pool = (<AsyncMock id='127692074869024'>, <AsyncMock name='mock.acquire().__aenter__()' id='127692074363424'>)

    @pytest.mark.asyncio
    async def test_get_chunk(service, mock_pool):
        """Test retrieving single chunk."""
        pool, conn = mock_pool
    
        conn.fetchrow.return_value = {
            "chunk_id": "1",
            "text": "Hello",
            "metadata": '{"source": "doc1"}'
        }
    
>       chunk = await service.get_chunk("1")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/services/test_database_service.py:137: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/database/postgres.py:256: in get_chunk
    pool = await self._get_pool()
           ^^^^^^^^^^^^^^^^^^^^^^
rag_factory/services/database/postgres.py:98: in _get_pool
    self._pool = await asyncpg.create_pool(
venv/lib/python3.12/site-packages/asyncpg/pool.py:439: in _async__init__
    await self._initialize()
venv/lib/python3.12/site-packages/asyncpg/pool.py:466: in _initialize
    await first_ch.connect()
venv/lib/python3.12/site-packages/asyncpg/pool.py:153: in connect
    self._con = await self._pool._get_new_connection()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/pool.py:538: in _get_new_connection
    con = await self._connect(
venv/lib/python3.12/site-packages/asyncpg/connection.py:2443: in connect
    return await connect_utils._connect(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1249: in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1218: in _connect
    conn = await _connect_addr(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1054: in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1099: in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:969: in _create_ssl_connection
    tr, pr = await loop.create_connection(
/usr/lib/python3.12/asyncio/base_events.py:1122: in create_connection
    raise exceptions[0]
/usr/lib/python3.12/asyncio/base_events.py:1104: in create_connection
    sock = await self._connect_sock(
/usr/lib/python3.12/asyncio/base_events.py:1007: in _connect_sock
    await self.sock_connect(sock, address)
/usr/lib/python3.12/asyncio/selector_events.py:651: in sock_connect
    return await fut
           ^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>
fut = None, sock = <socket.socket [closed] fd=-1, family=2, type=1, proto=6>
address = ('127.0.0.1', 5432)

    def _sock_connect_cb(self, fut, sock, address):
        if fut.done():
            return
    
        try:
            err = sock.getsockopt(socket.SOL_SOCKET, socket.SO_ERROR)
            if err != 0:
                # Jump to any except clause below.
>               raise OSError(err, f'Connect call failed {address}')
E               ConnectionRefusedError: [Errno 111] Connect call failed ('127.0.0.1', 5432)

/usr/lib/python3.12/asyncio/selector_events.py:691: ConnectionRefusedError
___________________________ test_get_chunk_not_found ___________________________

service = <rag_factory.services.database.postgres.PostgresqlDatabaseService object at 0x7422a2410590>
mock_pool = (<AsyncMock id='127692135209808'>, <AsyncMock name='mock.acquire().__aenter__()' id='127692095268112'>)

    @pytest.mark.asyncio
    async def test_get_chunk_not_found(service, mock_pool):
        """Test retrieving non-existent chunk."""
        pool, conn = mock_pool
        conn.fetchrow.return_value = None
    
        with pytest.raises(ValueError, match="Chunk not found"):
>           await service.get_chunk("999")

tests/unit/services/test_database_service.py:151: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/database/postgres.py:256: in get_chunk
    pool = await self._get_pool()
           ^^^^^^^^^^^^^^^^^^^^^^
rag_factory/services/database/postgres.py:98: in _get_pool
    self._pool = await asyncpg.create_pool(
venv/lib/python3.12/site-packages/asyncpg/pool.py:439: in _async__init__
    await self._initialize()
venv/lib/python3.12/site-packages/asyncpg/pool.py:466: in _initialize
    await first_ch.connect()
venv/lib/python3.12/site-packages/asyncpg/pool.py:153: in connect
    self._con = await self._pool._get_new_connection()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/pool.py:538: in _get_new_connection
    con = await self._connect(
venv/lib/python3.12/site-packages/asyncpg/connection.py:2443: in connect
    return await connect_utils._connect(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1249: in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1218: in _connect
    conn = await _connect_addr(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1054: in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1099: in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:969: in _create_ssl_connection
    tr, pr = await loop.create_connection(
/usr/lib/python3.12/asyncio/base_events.py:1122: in create_connection
    raise exceptions[0]
/usr/lib/python3.12/asyncio/base_events.py:1104: in create_connection
    sock = await self._connect_sock(
/usr/lib/python3.12/asyncio/base_events.py:1007: in _connect_sock
    await self.sock_connect(sock, address)
/usr/lib/python3.12/asyncio/selector_events.py:651: in sock_connect
    return await fut
           ^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>
fut = None, sock = <socket.socket [closed] fd=-1, family=2, type=1, proto=6>
address = ('127.0.0.1', 5432)

    def _sock_connect_cb(self, fut, sock, address):
        if fut.done():
            return
    
        try:
            err = sock.getsockopt(socket.SOL_SOCKET, socket.SO_ERROR)
            if err != 0:
                # Jump to any except clause below.
>               raise OSError(err, f'Connect call failed {address}')
E               ConnectionRefusedError: [Errno 111] Connect call failed ('127.0.0.1', 5432)

/usr/lib/python3.12/asyncio/selector_events.py:691: ConnectionRefusedError
________________________ test_get_chunks_for_documents _________________________

service = <rag_factory.services.database.postgres.PostgresqlDatabaseService object at 0x7422a0bafb00>
mock_pool = (<AsyncMock id='127692095221840'>, <AsyncMock name='mock.acquire().__aenter__()' id='127692099893248'>)

    @pytest.mark.asyncio
    async def test_get_chunks_for_documents(service, mock_pool):
        """Test retrieving chunks for documents."""
        pool, conn = mock_pool
    
        conn.fetch.return_value = [
            {
                "chunk_id": "1",
                "text": "Hello",
                "metadata": '{"document_id": "doc1"}'
            },
            {
                "chunk_id": "2",
                "text": "World",
                "metadata": '{"document_id": "doc1"}'
            }
        ]
    
>       chunks = await service.get_chunks_for_documents(["doc1"])
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/services/test_database_service.py:171: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/database/postgres.py:289: in get_chunks_for_documents
    pool = await self._get_pool()
           ^^^^^^^^^^^^^^^^^^^^^^
rag_factory/services/database/postgres.py:98: in _get_pool
    self._pool = await asyncpg.create_pool(
venv/lib/python3.12/site-packages/asyncpg/pool.py:439: in _async__init__
    await self._initialize()
venv/lib/python3.12/site-packages/asyncpg/pool.py:466: in _initialize
    await first_ch.connect()
venv/lib/python3.12/site-packages/asyncpg/pool.py:153: in connect
    self._con = await self._pool._get_new_connection()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/pool.py:538: in _get_new_connection
    con = await self._connect(
venv/lib/python3.12/site-packages/asyncpg/connection.py:2443: in connect
    return await connect_utils._connect(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1249: in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1218: in _connect
    conn = await _connect_addr(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1054: in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1099: in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:969: in _create_ssl_connection
    tr, pr = await loop.create_connection(
/usr/lib/python3.12/asyncio/base_events.py:1122: in create_connection
    raise exceptions[0]
/usr/lib/python3.12/asyncio/base_events.py:1104: in create_connection
    sock = await self._connect_sock(
/usr/lib/python3.12/asyncio/base_events.py:1007: in _connect_sock
    await self.sock_connect(sock, address)
/usr/lib/python3.12/asyncio/selector_events.py:651: in sock_connect
    return await fut
           ^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>
fut = None, sock = <socket.socket [closed] fd=-1, family=2, type=1, proto=6>
address = ('127.0.0.1', 5432)

    def _sock_connect_cb(self, fut, sock, address):
        if fut.done():
            return
    
        try:
            err = sock.getsockopt(socket.SOL_SOCKET, socket.SO_ERROR)
            if err != 0:
                # Jump to any except clause below.
>               raise OSError(err, f'Connect call failed {address}')
E               ConnectionRefusedError: [Errno 111] Connect call failed ('127.0.0.1', 5432)

/usr/lib/python3.12/asyncio/selector_events.py:691: ConnectionRefusedError
__________________________________ test_close __________________________________

service = <rag_factory.services.database.postgres.PostgresqlDatabaseService object at 0x7422a0be40e0>
mock_pool = (<AsyncMock id='127692074815360'>, <AsyncMock name='mock.acquire().__aenter__()' id='127692074823952'>)

    @pytest.mark.asyncio
    async def test_close(service, mock_pool):
        """Test closing connection pool."""
        pool, _ = mock_pool
    
        # Initialize pool
>       await service._get_pool()

tests/unit/services/test_database_service.py:185: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/database/postgres.py:98: in _get_pool
    self._pool = await asyncpg.create_pool(
venv/lib/python3.12/site-packages/asyncpg/pool.py:439: in _async__init__
    await self._initialize()
venv/lib/python3.12/site-packages/asyncpg/pool.py:466: in _initialize
    await first_ch.connect()
venv/lib/python3.12/site-packages/asyncpg/pool.py:153: in connect
    self._con = await self._pool._get_new_connection()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/pool.py:538: in _get_new_connection
    con = await self._connect(
venv/lib/python3.12/site-packages/asyncpg/connection.py:2443: in connect
    return await connect_utils._connect(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1249: in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1218: in _connect
    conn = await _connect_addr(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1054: in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1099: in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:969: in _create_ssl_connection
    tr, pr = await loop.create_connection(
/usr/lib/python3.12/asyncio/base_events.py:1122: in create_connection
    raise exceptions[0]
/usr/lib/python3.12/asyncio/base_events.py:1104: in create_connection
    sock = await self._connect_sock(
/usr/lib/python3.12/asyncio/base_events.py:1007: in _connect_sock
    await self.sock_connect(sock, address)
/usr/lib/python3.12/asyncio/selector_events.py:651: in sock_connect
    return await fut
           ^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>
fut = None, sock = <socket.socket [closed] fd=-1, family=2, type=1, proto=6>
address = ('127.0.0.1', 5432)

    def _sock_connect_cb(self, fut, sock, address):
        if fut.done():
            return
    
        try:
            err = sock.getsockopt(socket.SOL_SOCKET, socket.SO_ERROR)
            if err != 0:
                # Jump to any except clause below.
>               raise OSError(err, f'Connect call failed {address}')
E               ConnectionRefusedError: [Errno 111] Connect call failed ('127.0.0.1', 5432)

/usr/lib/python3.12/asyncio/selector_events.py:691: ConnectionRefusedError
_____________________________ test_context_manager _____________________________

service = <rag_factory.services.database.postgres.PostgresqlDatabaseService object at 0x7422a1f9dca0>
mock_pool = (<AsyncMock id='127692074814400'>, <AsyncMock name='mock.acquire().__aenter__()' id='127692074310960'>)

    @pytest.mark.asyncio
    async def test_context_manager(service, mock_pool):
        """Test async context manager."""
        pool, _ = mock_pool
    
        async with service as s:
            assert s == service
>           await s._get_pool()

tests/unit/services/test_database_service.py:200: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/database/postgres.py:98: in _get_pool
    self._pool = await asyncpg.create_pool(
venv/lib/python3.12/site-packages/asyncpg/pool.py:439: in _async__init__
    await self._initialize()
venv/lib/python3.12/site-packages/asyncpg/pool.py:466: in _initialize
    await first_ch.connect()
venv/lib/python3.12/site-packages/asyncpg/pool.py:153: in connect
    self._con = await self._pool._get_new_connection()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/pool.py:538: in _get_new_connection
    con = await self._connect(
venv/lib/python3.12/site-packages/asyncpg/connection.py:2443: in connect
    return await connect_utils._connect(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1249: in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1218: in _connect
    conn = await _connect_addr(
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1054: in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:1099: in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/asyncpg/connect_utils.py:969: in _create_ssl_connection
    tr, pr = await loop.create_connection(
/usr/lib/python3.12/asyncio/base_events.py:1122: in create_connection
    raise exceptions[0]
/usr/lib/python3.12/asyncio/base_events.py:1104: in create_connection
    sock = await self._connect_sock(
/usr/lib/python3.12/asyncio/base_events.py:1007: in _connect_sock
    await self.sock_connect(sock, address)
/usr/lib/python3.12/asyncio/selector_events.py:651: in sock_connect
    return await fut
           ^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>
fut = None, sock = <socket.socket [closed] fd=-1, family=2, type=1, proto=6>
address = ('127.0.0.1', 5432)

    def _sock_connect_cb(self, fut, sock, address):
        if fut.done():
            return
    
        try:
            err = sock.getsockopt(socket.SOL_SOCKET, socket.SO_ERROR)
            if err != 0:
                # Jump to any except clause below.
>               raise OSError(err, f'Connect call failed {address}')
E               ConnectionRefusedError: [Errno 111] Connect call failed ('127.0.0.1', 5432)

/usr/lib/python3.12/asyncio/selector_events.py:691: ConnectionRefusedError
____________ TestDocumentationCompleteness.test_mkdocs_config_valid ____________

self = <test_documentation_completeness.TestDocumentationCompleteness object at 0x7422a44d2330>
project_root = PosixPath('/mnt/MCPProyects/ragTools')

    def test_mkdocs_config_valid(self, project_root):
        """Test that mkdocs.yml is valid."""
        mkdocs_path = project_root / "mkdocs.yml"
        assert mkdocs_path.exists(), "mkdocs.yml missing"
    
        with open(mkdocs_path, encoding='utf-8') as f:
>           config = yaml.safe_load(f)
                     ^^^^^^^^^^^^^^^^^

tests/unit/documentation/test_documentation_completeness.py:201: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/yaml/__init__.py:125: in safe_load
    return load(stream, SafeLoader)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/yaml/__init__.py:81: in load
    return loader.get_single_data()
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/yaml/constructor.py:51: in get_single_data
    return self.construct_document(node)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/yaml/constructor.py:60: in construct_document
    for dummy in generator:
venv/lib/python3.12/site-packages/yaml/constructor.py:413: in construct_yaml_map
    value = self.construct_mapping(node)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/yaml/constructor.py:218: in construct_mapping
    return super().construct_mapping(node, deep=deep)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/yaml/constructor.py:143: in construct_mapping
    value = self.construct_object(value_node, deep=deep)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/yaml/constructor.py:100: in construct_object
    data = constructor(self, node)
           ^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <yaml.loader.SafeLoader object at 0x7422a1fd8e30>
node = ScalarNode(tag='tag:yaml.org,2002:python/name:pymdownx.superfences.fence_code_format', value='')

    def construct_undefined(self, node):
>       raise ConstructorError(None, None,
                "could not determine a constructor for the tag %r" % node.tag,
                node.start_mark)
E       yaml.constructor.ConstructorError: could not determine a constructor for the tag 'tag:yaml.org,2002:python/name:pymdownx.superfences.fence_code_format'
E         in "/mnt/MCPProyects/ragTools/mkdocs.yml", line 61, column 19

venv/lib/python3.12/site-packages/yaml/constructor.py:427: ConstructorError
________________ TestAlembicMigrations.test_migration_downgrade ________________

self = <sqlalchemy.engine.base.Connection object at 0x7422a45c1520>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7422a0bac500>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7422a292f920>
statement = <sqlalchemy.dialects.postgresql.base.PGDDLCompiler object at 0x7422a292ed80>
parameters = [immutabledict({})]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1969: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7422a0bac500>
cursor = <cursor object at 0x7422a1fce4d0; closed: -1>
statement = '\nDROP INDEX idx_chunks_hierarchy', parameters = immutabledict({})
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7422a292f920>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.errors.UndefinedObject: index "idx_chunks_hierarchy" does not exist

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:922: UndefinedObject

The above exception was the direct cause of the following exception:

self = <tests.unit.database.test_migrations.TestAlembicMigrations object at 0x7422a40a80e0>
alembic_config = <alembic.config.Config object at 0x7422a2896cf0>
test_db_url = 'postgresql://rag_user:rag_password@192.168.56.1:5432/rag_test'

    def test_migration_downgrade(self, alembic_config: Config, test_db_url: str) -> None:
        """Test downgrading migrations."""
        # Upgrade to head first
        command.upgrade(alembic_config, "head")
    
        # Get current version
        engine = create_engine(test_db_url)
        with engine.connect() as conn:
            context = MigrationContext.configure(conn)
            before_downgrade = context.get_current_revision()
        engine.dispose()
    
        # Downgrade one version
>       command.downgrade(alembic_config, "-1")

tests/unit/database/test_migrations.py:67: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/alembic/command.py:449: in downgrade
    script.run_env()
venv/lib/python3.12/site-packages/alembic/script/base.py:583: in run_env
    util.load_python_file(self.dir, "env.py")
venv/lib/python3.12/site-packages/alembic/util/pyfiles.py:95: in load_python_file
    module = load_module_py(module_id, path)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/alembic/util/pyfiles.py:113: in load_module_py
    spec.loader.exec_module(module)  # type: ignore
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap_external>:995: in exec_module
    ???
<frozen importlib._bootstrap>:488: in _call_with_frames_removed
    ???
migrations/env.py:93: in <module>
    run_migrations_online()
migrations/env.py:87: in run_migrations_online
    context.run_migrations()
<string>:8: in run_migrations
    ???
venv/lib/python3.12/site-packages/alembic/runtime/environment.py:948: in run_migrations
    self.get_context().run_migrations(**kw)
venv/lib/python3.12/site-packages/alembic/runtime/migration.py:627: in run_migrations
    step.migration_fn(**kw)
migrations/versions/002_add_hierarchy_support.py:239: in downgrade
    op.drop_index("idx_chunks_hierarchy", table_name="chunks")
<string>:8: in drop_index
    ???
<string>:3: in drop_index
    ???
venv/lib/python3.12/site-packages/alembic/operations/ops.py:1128: in drop_index
    return operations.invoke(op)
           ^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/alembic/operations/base.py:445: in invoke
    return fn(self, operation)
           ^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/alembic/operations/toimpl.py:120: in drop_index
    operations.impl.drop_index(
venv/lib/python3.12/site-packages/alembic/ddl/impl.py:407: in drop_index
    self._exec(schema.DropIndex(index, **kw))
venv/lib/python3.12/site-packages/alembic/ddl/impl.py:207: in _exec
    return conn.execute(construct, multiparams)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
venv/lib/python3.12/site-packages/sqlalchemy/sql/ddl.py:181: in _execute_on_connection
    return connection._execute_ddl(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1528: in _execute_ddl
    ret = self._execute_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1848: in _execute_context
    return self._exec_single_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1988: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2343: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1969: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7422a0bac500>
cursor = <cursor object at 0x7422a1fce4d0; closed: -1>
statement = '\nDROP INDEX idx_chunks_hierarchy', parameters = immutabledict({})
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7422a292f920>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedObject) index "idx_chunks_hierarchy" does not exist
E       
E       [SQL: 
E       DROP INDEX idx_chunks_hierarchy]
E       (Background on this error at: https://sqlalche.me/e/20/f405)

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:922: ProgrammingError
----------------------------- Captured stderr call -----------------------------
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running downgrade 002 -> 001, Add hierarchy support to chunks table
_____________ TestAlembicMigrations.test_migration_creates_tables ______________

self = <tests.unit.database.test_migrations.TestAlembicMigrations object at 0x7422a40a8da0>
alembic_config = <alembic.config.Config object at 0x7422a0be0710>
test_db_url = 'postgresql://rag_user:rag_password@192.168.56.1:5432/rag_test'

    def test_migration_creates_tables(self, alembic_config: Config, test_db_url: str) -> None:
        """Test that migrations create expected tables."""
        # Upgrade to head
        command.upgrade(alembic_config, "head")
    
        # Check tables exist
        engine = create_engine(test_db_url)
        inspector = inspect(engine)
        tables = inspector.get_table_names()
    
        # Should have documents and chunks tables
>       assert "documents" in tables
E       AssertionError: assert 'documents' in ['alembic_version']

tests/unit/database/test_migrations.py:143: AssertionError
----------------------------- Captured stderr call -----------------------------
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
_____________ TestAlembicMigrations.test_migration_creates_indexes _____________

self = <tests.unit.database.test_migrations.TestAlembicMigrations object at 0x7422a40a90d0>
alembic_config = <alembic.config.Config object at 0x7422a0e270e0>
test_db_url = 'postgresql://rag_user:rag_password@192.168.56.1:5432/rag_test'

    def test_migration_creates_indexes(self, alembic_config: Config, test_db_url: str) -> None:
        """Test that migrations create expected indexes."""
        # Upgrade to head
        command.upgrade(alembic_config, "head")
    
        # Check indexes exist
        engine = create_engine(test_db_url)
        inspector = inspect(engine)
    
        # Check chunks table indexes
>       indexes = inspector.get_indexes("chunks")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/database/test_migrations.py:159: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/sqlalchemy/engine/reflection.py:1135: in get_indexes
    return self.dialect.get_indexes(
<string>:2: in get_indexes
    ???
venv/lib/python3.12/site-packages/sqlalchemy/engine/reflection.py:97: in cache
    ret = fn(self, con, *args, **kw)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/base.py:4243: in get_indexes
    return self._value_or_raise(data, table_name, schema)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7422a0e54590>
data = dict_items([]), table = 'chunks', schema = None

    def _value_or_raise(self, data, table, schema):
        try:
            return dict(data)[(schema, table)]
        except KeyError:
>           raise exc.NoSuchTableError(
                f"{schema}.{table}" if schema else table
            ) from None
E           sqlalchemy.exc.NoSuchTableError: chunks

venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/base.py:3452: NoSuchTableError
----------------------------- Captured stderr call -----------------------------
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
___ TestChunkRepositoryVectorSearch.test_search_similar_with_filter_success ____

self = <tests.unit.repositories.test_chunk_repository.TestChunkRepositoryVectorSearch object at 0x7422a40cd4f0>
chunk_repo = <rag_factory.repositories.chunk.ChunkRepository object at 0x7422a0485190>
mock_session = <Mock id='127692066806320'>
sample_embedding = [0.38107019591082225, 0.360712728016074, 0.9666379348470824, 0.8449800289947282, 0.5647144284350455, 0.5401244395339485, ...]

    def test_search_similar_with_filter_success(self, chunk_repo, mock_session, sample_embedding):
        """Test vector search filtered by document IDs."""
        doc_id = uuid4()
        mock_rows = [
            (uuid4(), doc_id, 0, "Chunk 1", sample_embedding, {}, None, None, 0.95),
        ]
        mock_result = Mock()
        mock_result.fetchall.return_value = mock_rows
        mock_session.execute.return_value = mock_result
        mock_session.merge.side_effect = lambda x: x
    
        results = chunk_repo.search_similar_with_filter(
            sample_embedding,
            top_k=5,
            document_ids=[doc_id]
        )
    
        assert len(results) == 1
>       assert results[0][0].document_id == doc_id
E       AssertionError: assert <Mock name='mock.query().filter().first().document_id' id='127692130012912'> == UUID('87812791-68fa-4fca-8aef-54ec39f177a9')
E        +  where <Mock name='mock.query().filter().first().document_id' id='127692130012912'> = <Mock name='mock.query().filter().first()' id='127692134226528'>.document_id

tests/unit/repositories/test_chunk_repository.py:398: AssertionError
____________ TestONNXLocalProvider.test_tokenization_with_tiktoken _____________

self = <test_onnx_local.TestONNXLocalProvider object at 0x7422a40ccf80>
mock_provider = <rag_factory.services.embedding.providers.onnx_local.ONNXLocalProvider object at 0x7422a070c350>
mock_session = <Mock name='create_onnx_session()' id='127692069280208'>

    def test_tokenization_with_tiktoken(self, mock_provider, mock_session):
        """Test tokenization with tiktoken."""
>       if mock_provider.tokenizer_type == "tiktoken":
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'ONNXLocalProvider' object has no attribute 'tokenizer_type'

tests/unit/services/embeddings/test_onnx_local.py:143: AttributeError
___________ TestONNXLocalProvider.test_tokenization_simple_fallback ____________

self = <test_onnx_local.TestONNXLocalProvider object at 0x7422a40cc6b0>
mock_provider = <rag_factory.services.embedding.providers.onnx_local.ONNXLocalProvider object at 0x7422a070db50>
mock_session = <Mock name='create_onnx_session()' id='127692069435104'>

    def test_tokenization_simple_fallback(self, mock_provider, mock_session):
        """Test simple tokenization fallback."""
        # Force simple tokenization
        mock_provider.tokenizer_type = "simple"
        mock_provider.tokenizer = None
    
        mock_embeddings = np.random.randn(1, 512, 384).astype(np.float32)
        mock_session.run.return_value = [mock_embeddings]
    
>       result = mock_provider.get_embeddings(["Test document"])
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/services/embeddings/test_onnx_local.py:164: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/services/embedding/providers/onnx_local.py:213: in get_embeddings
    input_ids, attention_mask = self._tokenize(texts)
                                ^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <rag_factory.services.embedding.providers.onnx_local.ONNXLocalProvider object at 0x7422a070db50>
texts = ['Test document']

    def _tokenize(self, texts: List[str]) -> tuple:
        """Tokenize texts for model input.
    
        Args:
            texts: List of texts to tokenize
    
        Returns:
            Tuple of (input_ids, attention_mask) as numpy arrays
        """
        if self.hf_tokenizer is not None:
            # Use tokenizers library (lightweight, no PyTorch)
            input_ids = []
            attention_mask = []
    
            for text in texts:
                # Encode with the tokenizer
                encoding = self.hf_tokenizer.encode(text)
                tokens = encoding.ids
    
                # Truncate if needed
                if len(tokens) > self.max_length:
                    tokens = tokens[:self.max_length]
    
                # Pad to max_length
                padding_length = self.max_length - len(tokens)
                padded_tokens = tokens + [0] * padding_length
                mask = [1] * len(tokens) + [0] * padding_length
    
                input_ids.append(padded_tokens)
                attention_mask.append(mask)
    
            return (
                np.array(input_ids, dtype=np.int64),
                np.array(attention_mask, dtype=np.int64)
            )
        else:
            # Fallback to basic tokenizer (may not work correctly)
            input_ids = []
            attention_mask = []
    
            for text in texts:
                # Encode text using our tokenizer
>               tokens = self.tokenizer.encode(text)
                         ^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'NoneType' object has no attribute 'encode'

rag_factory/services/embedding/providers/onnx_local.py:294: AttributeError
______________________________ test_mean_pooling _______________________________

mock_metadata = <MagicMock name='get_model_metadata' id='127692069647184'>
mock_validate = <MagicMock name='validate_onnx_model' id='127692067142064'>
mock_download = <MagicMock name='download_onnx_model' id='127692067138368'>
mock_session = <MagicMock name='create_onnx_session' id='127692067137504'>
onnx_config = {'max_batch_size': 32, 'model': 'Xenova/all-mpnet-base-v2'}
mock_onnx_available = None, mock_hf_hub_available = None

    @patch("rag_factory.services.embedding.providers.onnx_local.create_onnx_session")
    @patch("rag_factory.services.embedding.providers.onnx_local.download_onnx_model")
    @patch("rag_factory.services.embedding.providers.onnx_local.validate_onnx_model")
    @patch("rag_factory.services.embedding.providers.onnx_local.get_model_metadata")
    def test_mean_pooling(
        mock_metadata, mock_validate, mock_download, mock_session, onnx_config, mock_onnx_available, mock_hf_hub_available
    ):
        """Test mean pooling implementation."""
        from rag_factory.services.embedding.providers.onnx_local import ONNXLocalProvider
        from pathlib import Path
    
        mock_download.return_value = Path("/fake/path/to/onnx/model.onnx")
        mock_session_obj = Mock()
        mock_output = Mock()
        mock_output.shape = [1, 512, 768]
        mock_session_obj.get_outputs.return_value = [mock_output]
        mock_session.return_value = mock_session_obj
        mock_metadata.return_value = {"embedding_dim": 768}
    
        with patch("pathlib.Path.exists", return_value=True):
            with patch("tokenizers.Tokenizer.from_file"):
                provider = ONNXLocalProvider(onnx_config)
    
                # Create test data
                token_embeddings = np.random.randn(2, 10, 768).astype(np.float32)
                attention_mask = np.array([[1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                                          [1, 1, 1, 1, 1, 1, 1, 0, 0, 0]], dtype=np.int64)
    
                # Call mean pooling
>               result = provider._mean_pooling(token_embeddings, attention_mask)
                         ^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'ONNXLocalProvider' object has no attribute '_mean_pooling'

tests/unit/services/embedding/test_onnx_local_provider.py:306: AttributeError
________________________ test_long_document_truncation _________________________

document_embedder = <rag_factory.strategies.late_chunking.document_embedder.DocumentEmbedder object at 0x7422a04d09e0>
mock_session = <Mock name='create_onnx_session()' id='127692067150384'>
mock_tokenizer = <Mock name='from_pretrained()' id='127692067157920'>

    def test_long_document_truncation(document_embedder, mock_session, mock_tokenizer):
        """Test that long documents are truncated."""
        # Create very long text
        long_text = "This is a sentence. " * 1000
    
        # Mock tokenizer to return many tokens
        long_token_ids = list(range(1000))
        mock_tokenizer.encode.return_value = long_token_ids
    
        # Mock ONNX output for truncated length
        truncated_length = document_embedder.max_length
        mock_embeddings = np.random.randn(1, truncated_length, 384).astype(np.float32)
        mock_session.run.return_value = [mock_embeddings]
    
>       doc_emb = document_embedder.embed_document(long_text, "long_doc")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/strategies/late_chunking/test_document_embedder.py:161: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/strategies/late_chunking/document_embedder.py:129: in embed_document
    full_embedding = self._mean_pooling(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <rag_factory.strategies.late_chunking.document_embedder.DocumentEmbedder object at 0x7422a04d09e0>
token_embeddings = array([[-0.18369581,  0.44101617, -1.4310585 , ...,  1.0352337 ,
        -0.17732362,  1.3031758 ],
       [ 2.0712597...9374 , -0.18834113,  1.385326  , ..., -1.1171865 ,
        -0.87429786,  0.10312199]], shape=(512, 384), dtype=float32)
attention_mask = array([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,...1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1])

    def _mean_pooling(
        self,
        token_embeddings: np.ndarray,
        attention_mask: np.ndarray
    ) -> np.ndarray:
        """
        Mean pooling to get document-level embedding.
    
        Args:
            token_embeddings: Token-level embeddings [seq_length, embedding_dim]
            attention_mask: Attention mask [seq_length]
    
        Returns:
            Document embedding [embedding_dim]
        """
        # Expand attention mask to match embedding dimensions
        attention_mask_expanded = np.expand_dims(attention_mask, axis=-1)
        attention_mask_expanded = attention_mask_expanded.astype(np.float32)
    
        # Sum embeddings, weighted by attention mask
>       sum_embeddings = np.sum(token_embeddings * attention_mask_expanded, axis=0)
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       ValueError: operands could not be broadcast together with shapes (512,384) (1000,1)

rag_factory/strategies/late_chunking/document_embedder.py:199: ValueError
_____________________ test_embedding_dimensions_consistent _____________________

document_embedder = <rag_factory.strategies.late_chunking.document_embedder.DocumentEmbedder object at 0x7422a0768080>
mock_session = <Mock name='create_onnx_session()' id='127692067526016'>
mock_tokenizer = <Mock name='from_pretrained()' id='127692067526160'>

    def test_embedding_dimensions_consistent(document_embedder, mock_session, mock_tokenizer):
        """Test that embedding dimensions are consistent."""
        # Mock different token counts
        mock_embeddings1 = np.random.randn(1, 3, 384).astype(np.float32)
        mock_embeddings2 = np.random.randn(1, 7, 384).astype(np.float32)
    
        mock_tokenizer.encode.side_effect = [[1, 2, 3], [1, 2, 3, 4, 5, 6, 7]]
        mock_session.run.side_effect = [[mock_embeddings1], [mock_embeddings2]]
    
        text1 = "Short text"
        text2 = "This is a longer text with more words"
    
>       doc_emb1 = document_embedder.embed_document(text1, "doc1")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/strategies/late_chunking/test_document_embedder.py:203: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/strategies/late_chunking/document_embedder.py:129: in embed_document
    full_embedding = self._mean_pooling(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <rag_factory.strategies.late_chunking.document_embedder.DocumentEmbedder object at 0x7422a0768080>
token_embeddings = array([[-0.9358329 , -1.9695941 , -0.78902537, ..., -1.4753344 ,
        -0.59679204, -0.11081211],
       [ 1.6828526...920245 ,  0.7872449 , -0.2274204 , ...,  0.08287209,
         0.94319826,  0.03756734]], shape=(3, 384), dtype=float32)
attention_mask = array([1, 1, 1, 1, 1])

    def _mean_pooling(
        self,
        token_embeddings: np.ndarray,
        attention_mask: np.ndarray
    ) -> np.ndarray:
        """
        Mean pooling to get document-level embedding.
    
        Args:
            token_embeddings: Token-level embeddings [seq_length, embedding_dim]
            attention_mask: Attention mask [seq_length]
    
        Returns:
            Document embedding [embedding_dim]
        """
        # Expand attention mask to match embedding dimensions
        attention_mask_expanded = np.expand_dims(attention_mask, axis=-1)
        attention_mask_expanded = attention_mask_expanded.astype(np.float32)
    
        # Sum embeddings, weighted by attention mask
>       sum_embeddings = np.sum(token_embeddings * attention_mask_expanded, axis=0)
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       ValueError: operands could not be broadcast together with shapes (3,384) (5,1)

rag_factory/strategies/late_chunking/document_embedder.py:199: ValueError
___________________________ test_pipeline_add_stage ____________________________

    def test_pipeline_add_stage() -> None:
        """Test adding stages to pipeline."""
        pipeline = StrategyPipeline()
>       strategy = DummyStrategy()
                   ^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class DummyStrategy without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:59: TypeError
____________________________ test_pipeline_chaining ____________________________

    def test_pipeline_chaining() -> None:
        """Test add_stage supports method chaining."""
        class Strategy1(IRAGStrategy):
            """Test strategy 1."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class Strategy2(IRAGStrategy):
            """Test strategy 2."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = (StrategyPipeline()
>                   .add_stage(Strategy1(), "stage1")
                               ^^^^^^^^^^^
                    .add_stage(Strategy2(), "stage2"))
E       TypeError: Can't instantiate abstract class Strategy1 without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:115: TypeError
_______________________ test_sequential_execution_order ________________________

    def test_sequential_execution_order() -> None:
        """Test strategies execute in correct order."""
        execution_order: List[int] = []
    
        class Strategy1(IRAGStrategy):
            """Test strategy that tracks execution order."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve and track execution."""
                execution_order.append(1)
                return [Chunk("Result1", {}, 0.9, "doc1", "chunk1")]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class Strategy2(IRAGStrategy):
            """Test strategy that tracks execution order."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve and track execution."""
                execution_order.append(2)
                return [Chunk("Result2", {}, 0.8, "doc2", "chunk2")]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline(mode=ExecutionMode.SEQUENTIAL)
>       pipeline.add_stage(Strategy1(), "strategy1")
                           ^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class Strategy1 without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:175: TypeError
__________________ test_sequential_execution_collects_results __________________

    def test_sequential_execution_collects_results() -> None:
        """Test sequential execution collects all results."""
        class Strategy1(IRAGStrategy):
            """Test strategy returning result A."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return [Chunk("A", {}, 0.9, "doc1", "chunk1")]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class Strategy2(IRAGStrategy):
            """Test strategy returning result B."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return [Chunk("B", {}, 0.8, "doc2", "chunk2")]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline(mode=ExecutionMode.SEQUENTIAL)
>       pipeline.add_stage(Strategy1(), "s1")
                           ^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class Strategy1 without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:233: TypeError
___________________________ test_parallel_execution ____________________________

    @pytest.mark.asyncio
    async def test_parallel_execution() -> None:
        """Test strategies execute in parallel."""
        import asyncio
    
        execution_times: Dict[str, float] = {}
    
        class SlowStrategy(IRAGStrategy):
            """Slow strategy for parallel testing."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve with delay."""
                start = time.time()
                await asyncio.sleep(0.1)
                execution_times["slow"] = time.time() - start
                return [Chunk("Slow", {}, 0.9, "doc1", "chunk1")]
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class FastStrategy(IRAGStrategy):
            """Fast strategy for parallel testing."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve with delay."""
                start = time.time()
                await asyncio.sleep(0.05)
                execution_times["fast"] = time.time() - start
                return [Chunk("Fast", {}, 0.8, "doc2", "chunk2")]
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline(mode=ExecutionMode.PARALLEL)
>       pipeline.add_stage(SlowStrategy(), "slow")
                           ^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class SlowStrategy without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:305: TypeError
__________________________ test_strategy_error_caught __________________________

    def test_strategy_error_caught() -> None:
        """Test pipeline catches strategy errors."""
        class FailingStrategy(IRAGStrategy):
            """Strategy that always fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve - raises error."""
                raise RuntimeError("Strategy failed")
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class WorkingStrategy(IRAGStrategy):
            """Strategy that works correctly."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return [Chunk("Success", {}, 0.9, "doc1", "chunk1")]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline(mode=ExecutionMode.SEQUENTIAL)
        stage = PipelineStage(
>           strategy=FailingStrategy(),
                     ^^^^^^^^^^^^^^^^^
            name="failing",
            required=False
        )
E       TypeError: Can't instantiate abstract class FailingStrategy without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:368: TypeError
_______________________ test_fallback_strategy_executed ________________________

    def test_fallback_strategy_executed() -> None:
        """Test fallback strategy used on primary failure."""
        class PrimaryStrategy(IRAGStrategy):
            """Primary strategy that fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve - raises error."""
                raise RuntimeError("Primary failed")
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class FallbackStrategy(IRAGStrategy):
            """Fallback strategy that succeeds."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return [Chunk("Fallback", {}, 0.7, "doc1", "chunk1")]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline()
        pipeline.add_stage(
>           PrimaryStrategy(),
            ^^^^^^^^^^^^^^^^^
            "primary",
            fallback=FallbackStrategy()
        )
E       TypeError: Can't instantiate abstract class PrimaryStrategy without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:432: TypeError
________________________ test_duplicate_results_removed ________________________

    def test_duplicate_results_removed() -> None:
        """Test duplicate results are deduplicated."""
        class Strategy1(IRAGStrategy):
            """Strategy returning duplicate and unique results."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return [
                    Chunk("Duplicate", {}, 0.9, "doc1", "chunk1"),
                    Chunk("Unique1", {}, 0.8, "doc2", "chunk2")
                ]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class Strategy2(IRAGStrategy):
            """Strategy returning duplicate and unique results."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return [
                    Chunk("Duplicate", {}, 0.85, "doc1", "chunk1"),
                    Chunk("Unique2", {}, 0.75, "doc3", "chunk3")
                ]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline()
>       pipeline.add_stage(Strategy1(), "s1")
                           ^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class Strategy1 without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:499: TypeError
_________________________ test_results_sorted_by_score _________________________

    def test_results_sorted_by_score() -> None:
        """Test merged results sorted by relevance score."""
        class Strategy1(IRAGStrategy):
            """Strategy returning low-score result."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return [Chunk("Low", {}, 0.6, "doc1", "chunk1")]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class Strategy2(IRAGStrategy):
            """Strategy returning high-score result."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return [Chunk("High", {}, 0.95, "doc2", "chunk2")]
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline()
>       pipeline.add_stage(Strategy1(), "s1")
                           ^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class Strategy1 without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:558: TypeError
______________________ test_performance_metrics_collected ______________________

    def test_performance_metrics_collected() -> None:
        """Test execution time tracked for each stage."""
        class Strategy1(IRAGStrategy):
            """Strategy with artificial delay."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve with delay."""
                time.sleep(0.01)
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline()
>       pipeline.add_stage(Strategy1(), "s1")
                           ^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class Strategy1 without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:595: TypeError
______________________ test_from_config_creates_pipeline _______________________

    def test_from_config_creates_pipeline() -> None:
        """Test pipeline can be created from config dict."""
        from rag_factory.factory import RAGFactory
    
        config = {
            "mode": "sequential",
            "stages": [
                {
                    "strategy": "dummy",
                    "name": "stage1",
                    "config": {"chunk_size": 512}
                }
            ]
        }
    
        # Register dummy strategy
        RAGFactory.register_strategy("dummy", DummyStrategy, override=True)
    
>       pipeline = StrategyPipeline.from_config(config)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_pipeline.py:623: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rag_factory/pipeline.py:496: in from_config
    strategy = factory.create_strategy(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <rag_factory.factory.RAGFactory object at 0x7422a04d6660>, name = 'dummy'
config = {'chunk_size': 512}, override_deps = None

    def create_strategy(
        self,
        name: str,
        config: Optional[Dict[str, Any]] = None,
        override_deps: Optional[StrategyDependencies] = None,
    ) -> IRAGStrategy:
        """
        Create and initialize a strategy instance with dependency injection.
    
        Args:
            name: Name of the registered strategy to create
            config: Optional configuration dictionary for the strategy
            override_deps: Optional dependencies to override factory defaults
    
        Returns:
            IRAGStrategy: Initialized strategy instance
    
        Raises:
            StrategyNotFoundError: If strategy name not in registry
            ValueError: If required services are missing or config is invalid
    
        Example:
            >>> factory = RAGFactory(llm_service=my_llm)
            >>> config = {"chunk_size": 1024, "top_k": 10}
            >>> strategy = factory.create_strategy("my_strategy", config)
            >>>
            >>> # Or with override dependencies
            >>> override = StrategyDependencies(llm_service=different_llm)
            >>> strategy = factory.create_strategy("my_strategy", config, override)
        """
        if name not in self._registry:
            available = list(self._registry.keys())
            raise StrategyNotFoundError(
                f"Strategy '{name}' not found. "
                f"Available strategies: {available}"
            )
    
        strategy_class = self._registry[name]
        deps = override_deps or self.dependencies
    
        # Use config dict or empty dict if not provided
        strategy_config = config or {}
    
        try:
            # Strategy constructor will validate dependencies
>           strategy = strategy_class(config=strategy_config, dependencies=deps)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: Can't instantiate abstract class DummyStrategy without an implementation for abstract method 'requires_services'

rag_factory/factory.py:217: TypeError
______________________ test_cascade_mode_not_implemented _______________________

    def test_cascade_mode_not_implemented() -> None:
        """Test CASCADE mode raises NotImplementedError."""
        pipeline = StrategyPipeline(mode=ExecutionMode.CASCADE)
>       pipeline.add_stage(DummyStrategy(), "stage1")
                           ^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class DummyStrategy without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:633: TypeError
___________________ test_cascade_mode_not_implemented_async ____________________

    @pytest.mark.asyncio
    async def test_cascade_mode_not_implemented_async() -> None:
        """Test CASCADE mode raises NotImplementedError in async."""
        pipeline = StrategyPipeline(mode=ExecutionMode.CASCADE)
>       pipeline.add_stage(DummyStrategy(), "stage1")
                           ^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class DummyStrategy without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:643: TypeError
_________________ test_required_stage_failure_raises_exception _________________

    def test_required_stage_failure_raises_exception() -> None:
        """Test required stage failure raises exception."""
        class FailingRequiredStrategy(IRAGStrategy):
            """Strategy that fails and is required."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve - raises error."""
                raise ValueError("Required strategy failed")
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline()
        # Add required failing stage (required=True is default)
>       pipeline.add_stage(FailingRequiredStrategy(), "required_failing")
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class FailingRequiredStrategy without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:676: TypeError
______________ test_required_stage_failure_raises_exception_async ______________

    @pytest.mark.asyncio
    async def test_required_stage_failure_raises_exception_async() -> None:
        """Test required stage failure raises exception in async mode."""
        class FailingRequiredAsyncStrategy(IRAGStrategy):
            """Strategy that fails in async mode and is required."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise ValueError("Required async strategy failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline(mode=ExecutionMode.SEQUENTIAL)
>       pipeline.add_stage(FailingRequiredAsyncStrategy(), "required_failing")
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class FailingRequiredAsyncStrategy without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:709: TypeError
_____________________ test_fallback_failure_when_required ______________________

    def test_fallback_failure_when_required() -> None:
        """Test fallback failure on required stage raises exception."""
        class FailingPrimary(IRAGStrategy):
            """Primary strategy that fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve - raises error."""
                raise RuntimeError("Primary failed")
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class FailingFallback(IRAGStrategy):
            """Fallback strategy that also fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve - raises error."""
                raise RuntimeError("Fallback failed")
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline()
        pipeline.add_stage(
>           FailingPrimary(),
            ^^^^^^^^^^^^^^^^
            "primary",
            fallback=FailingFallback()
        )
E       TypeError: Can't instantiate abstract class FailingPrimary without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:765: TypeError
__________________ test_fallback_failure_when_required_async ___________________

    @pytest.mark.asyncio
    async def test_fallback_failure_when_required_async() -> None:
        """Test fallback failure on required stage raises exception in async."""
        class FailingPrimaryAsync(IRAGStrategy):
            """Primary async strategy that fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Primary async failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class FailingFallbackAsync(IRAGStrategy):
            """Fallback async strategy that also fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Fallback async failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline(mode=ExecutionMode.SEQUENTIAL)
        pipeline.add_stage(
>           FailingPrimaryAsync(),
            ^^^^^^^^^^^^^^^^^^^^^
            "primary",
            fallback=FailingFallbackAsync()
        )
E       TypeError: Can't instantiate abstract class FailingPrimaryAsync without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:825: TypeError
_____________________ test_parallel_required_stage_failure _____________________

    @pytest.mark.asyncio
    async def test_parallel_required_stage_failure() -> None:
        """Test parallel execution with required stage failure."""
        class FailingParallelRequired(IRAGStrategy):
            """Required strategy that fails in parallel mode."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Parallel required failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline(mode=ExecutionMode.PARALLEL)
>       pipeline.add_stage(FailingParallelRequired(), "failing_required")
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class FailingParallelRequired without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:861: TypeError
___________________ test_parallel_required_fallback_failure ____________________

    @pytest.mark.asyncio
    async def test_parallel_required_fallback_failure() -> None:
        """Test parallel execution with required stage and failing fallback."""
        class FailingParallelPrimary(IRAGStrategy):
            """Primary strategy that fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Parallel primary failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class FailingParallelFallback(IRAGStrategy):
            """Fallback strategy that fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Parallel fallback failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        pipeline = StrategyPipeline(mode=ExecutionMode.PARALLEL)
        pipeline.add_stage(
>           FailingParallelPrimary(),
            ^^^^^^^^^^^^^^^^^^^^^^^^
            "primary",
            fallback=FailingParallelFallback()
        )
E       TypeError: Can't instantiate abstract class FailingParallelPrimary without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:918: TypeError
_________________ test_non_required_fallback_failure_continues _________________

    def test_non_required_fallback_failure_continues() -> None:
        """Test non-required stage with failing fallback continues pipeline."""
        class FailingPrimaryNonReq(IRAGStrategy):
            """Primary strategy that fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve - raises error."""
                raise RuntimeError("Primary failed")
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class FailingFallbackNonReq(IRAGStrategy):
            """Fallback strategy that also fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve - raises error."""
                raise RuntimeError("Fallback failed")
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve."""
                return []
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        from rag_factory.pipeline import PipelineStage
    
        pipeline = StrategyPipeline()
        stage = PipelineStage(
>           strategy=FailingPrimaryNonReq(),
                     ^^^^^^^^^^^^^^^^^^^^^^
            name="non_required",
            fallback=FailingFallbackNonReq(),
            required=False
        )
E       TypeError: Can't instantiate abstract class FailingPrimaryNonReq without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:979: TypeError
______________ test_non_required_fallback_failure_continues_async ______________

    @pytest.mark.asyncio
    async def test_non_required_fallback_failure_continues_async() -> None:
        """Test non-required stage with failing fallback continues in async."""
        class FailingPrimaryAsyncNonReq(IRAGStrategy):
            """Primary async strategy that fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Primary async failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class FailingFallbackAsyncNonReq(IRAGStrategy):
            """Fallback async strategy that also fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Fallback async failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        from rag_factory.pipeline import PipelineStage
    
        pipeline = StrategyPipeline(mode=ExecutionMode.SEQUENTIAL)
        stage = PipelineStage(
>           strategy=FailingPrimaryAsyncNonReq(),
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
            name="non_required",
            fallback=FailingFallbackAsyncNonReq(),
            required=False
        )
E       TypeError: Can't instantiate abstract class FailingPrimaryAsyncNonReq without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:1044: TypeError
_________________ test_parallel_non_required_fallback_success __________________

    @pytest.mark.asyncio
    async def test_parallel_non_required_fallback_success() -> None:
        """Test parallel execution with non-required stage and successful fallback."""
        class FailingParallelPrimaryNonReq(IRAGStrategy):
            """Primary strategy that fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Parallel primary failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class WorkingParallelFallback(IRAGStrategy):
            """Fallback strategy that works."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - returns result."""
                return [Chunk("Fallback", {}, 0.7, "doc1", "c1")]
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        from rag_factory.pipeline import PipelineStage
    
        pipeline = StrategyPipeline(mode=ExecutionMode.PARALLEL)
        stage = PipelineStage(
>           strategy=FailingParallelPrimaryNonReq(),
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            name="non_required_with_fallback",
            fallback=WorkingParallelFallback(),
            required=False
        )
E       TypeError: Can't instantiate abstract class FailingParallelPrimaryNonReq without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:1109: TypeError
_____________________ test_parallel_non_required_both_fail _____________________

    @pytest.mark.asyncio
    async def test_parallel_non_required_both_fail() -> None:
        """Test parallel execution with non-required stage where both fail."""
        class FailingParallelPrimaryBoth(IRAGStrategy):
            """Primary strategy that fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Primary failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        class FailingParallelFallbackBoth(IRAGStrategy):
            """Fallback strategy that also fails."""
    
            def initialize(self, config: Any) -> None:
                """Initialize."""
                pass
    
            def prepare_data(self, documents: List[Dict[str, Any]]) -> Any:
                """Prepare data."""
                return None
    
            def retrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Retrieve."""
                return []
    
            async def aretrieve(self, query: str, top_k: int) -> List[Chunk]:
                """Async retrieve - raises error."""
                raise RuntimeError("Fallback failed")
    
            def process_query(self, query: str, context: List[Chunk]) -> str:
                """Process query."""
                return ""
    
        from rag_factory.pipeline import PipelineStage
    
        pipeline = StrategyPipeline(mode=ExecutionMode.PARALLEL)
        stage = PipelineStage(
>           strategy=FailingParallelPrimaryBoth(),
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            name="both_fail",
            fallback=FailingParallelFallbackBoth(),
            required=False
        )
E       TypeError: Can't instantiate abstract class FailingParallelPrimaryBoth without an implementation for abstract method 'requires_services'

tests/unit/test_pipeline.py:1175: TypeError
=============================== warnings summary ===============================
rag_factory/services/llm/config.py:8
  /mnt/MCPProyects/ragTools/rag_factory/services/llm/config.py:8: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class LLMServiceConfig(BaseModel):

rag_factory/database/config.py:12
  /mnt/MCPProyects/ragTools/rag_factory/database/config.py:12: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DatabaseConfig(BaseSettings):

rag_factory/strategies/agentic/config.py:9
  /mnt/MCPProyects/ragTools/rag_factory/strategies/agentic/config.py:9: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AgenticStrategyConfig(BaseModel):

rag_factory/strategies/late_chunking/models.py:21
  /mnt/MCPProyects/ragTools/rag_factory/strategies/late_chunking/models.py:21: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TokenEmbedding(BaseModel):

rag_factory/strategies/late_chunking/models.py:34
  /mnt/MCPProyects/ragTools/rag_factory/strategies/late_chunking/models.py:34: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DocumentEmbedding(BaseModel):

rag_factory/strategies/late_chunking/models.py:49
  /mnt/MCPProyects/ragTools/rag_factory/strategies/late_chunking/models.py:49: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class EmbeddingChunk(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.3-final-0 ________________

Name                                                               Stmts   Miss  Cover   Missing
------------------------------------------------------------------------------------------------
rag_factory/__init__.py                                               37      9    76%   100-101, 107-109, 121-122, 130-131
rag_factory/__version__.py                                             1      0   100%
rag_factory/cli/__init__.py                                            2      0   100%
rag_factory/cli/commands/__init__.py                                   1      0   100%
rag_factory/cli/commands/benchmark.py                                 96     81    16%   40-53, 64-84, 148-263
rag_factory/cli/commands/check_consistency.py                         38      2    95%   77, 111
rag_factory/cli/commands/config.py                                    78     68    13%   26-64, 102-188
rag_factory/cli/commands/index.py                                     65     52    20%   29-39, 93-185
rag_factory/cli/commands/query.py                                     47     36    23%   73-149
rag_factory/cli/commands/repl.py                                     153    109    29%   35-40, 63-108, 112-120, 124-133, 137-155, 159-172, 176-187, 204-208, 212-221, 257-261
rag_factory/cli/commands/strategies.py                                45     36    20%   48-120
rag_factory/cli/commands/validate_pipeline.py                         70     57    19%   57-156
rag_factory/cli/formatters/__init__.py                                 4      0   100%
rag_factory/cli/formatters/consistency.py                             61      0   100%
rag_factory/cli/formatters/output.py                                  20      3    85%   63-64, 84
rag_factory/cli/formatters/results.py                                 71     62    13%   28-55, 72-99, 116-144, 157-181
rag_factory/cli/formatters/validation.py                              63     53    16%   25-43, 48-56, 65-77, 86-98, 103-129, 134-137
rag_factory/cli/main.py                                               30      8    73%   26-28, 49, 74-76, 80
rag_factory/cli/utils/__init__.py                                      3      0   100%
rag_factory/cli/utils/progress.py                                     14      8    43%   34-47, 73-76
rag_factory/cli/utils/validation.py                                   53     42    21%   30-41, 57-77, 93-118, 135
rag_factory/config.py                                                155     99    36%   134-139, 189-191, 216-232, 247-266, 275, 301-310, 327-335, 357-369, 388-395, 416-440, 449-452, 464-469, 479, 496-498, 506-508, 521-526, 536-542
rag_factory/core/__init__.py                                           4      4     0%   7-23
rag_factory/core/capabilities.py                                      61     16    74%   129, 155, 173-174, 239-253
rag_factory/core/indexing_interface.py                                54     35    35%   55-57, 118-123, 144, 164, 208, 260, 272, 292-313, 341-364
rag_factory/core/pipeline.py                                          49     35    29%   22-24, 33-40, 55-77, 95-96, 105-108, 117-120, 137-146
rag_factory/core/retrieval_interface.py                               38     20    47%   56-58, 112-117, 138, 158, 196, 247, 259, 285-309
rag_factory/database/__init__.py                                       4      0   100%
rag_factory/database/config.py                                        17      0   100%
rag_factory/database/connection.py                                    80     54    32%   40-48, 61-86, 96, 107, 126-137, 150-157, 165-170, 178-183, 196-197, 209-214, 218, 222
rag_factory/database/env_validator.py                                 38     18    53%   46-54, 66-77, 86-88, 118, 126, 139
rag_factory/database/models.py                                        85     32    62%   31-34, 37-45, 48-54, 66-69, 72-77, 80-85, 181, 323-325
rag_factory/database/vector_indexing.py                               38     38     0%   7-114
rag_factory/evaluation/__init__.py                                     4      4     0%   29-41
rag_factory/evaluation/analysis/__init__.py                            3      3     0%   8-11
rag_factory/evaluation/analysis/comparison.py                        135    135     0%   8-323
rag_factory/evaluation/analysis/statistics.py                         81     81     0%   8-320
rag_factory/evaluation/benchmarks/__init__.py                          3      3     0%   8-14
rag_factory/evaluation/benchmarks/config.py                           25     25     0%   7-64
rag_factory/evaluation/benchmarks/runner.py                          155    155     0%   8-423
rag_factory/evaluation/datasets/__init__.py                            3      3     0%   8-14
rag_factory/evaluation/datasets/loader.py                             88     88     0%   8-281
rag_factory/evaluation/datasets/schema.py                             52     52     0%   8-160
rag_factory/evaluation/datasets/statistics.py                         65     65     0%   8-226
rag_factory/evaluation/exporters/__init__.py                           4      4     0%   8-12
rag_factory/evaluation/exporters/csv_exporter.py                      52     52     0%   3-124
rag_factory/evaluation/exporters/html_exporter.py                     47     47     0%   3-293
rag_factory/evaluation/exporters/json_exporter.py                     19     19     0%   3-68
rag_factory/evaluation/metrics/__init__.py                             3      3     0%   12-25
rag_factory/evaluation/metrics/base.py                                31     31     0%   8-115
rag_factory/evaluation/metrics/cost.py                                65     65     0%   8-313
rag_factory/evaluation/metrics/performance.py                         42     42     0%   8-202
rag_factory/evaluation/metrics/quality.py                             84     84     0%   8-377
rag_factory/evaluation/metrics/retrieval.py                           77     77     0%   9-401
rag_factory/exceptions.py                                             13      0   100%
rag_factory/factory.py                                               187    132    29%   144, 165-170, 203-204, 222, 226-230, 256-270, 300-324, 347-348, 365, 384, 401, 418, 435, 451-460, 480-502, 528-545, 568-611, 644-699, 703-715, 744-749
rag_factory/models/__init__.py                                         6      6     0%   3-14
rag_factory/models/embedding/__init__.py                               4      4     0%   3-12
rag_factory/models/embedding/loader.py                               179    179     0%   3-367
rag_factory/models/embedding/models.py                                47     47     0%   3-106
rag_factory/models/embedding/registry.py                             128    128     0%   3-282
rag_factory/models/evaluation/__init__.py                              3      3     0%   3-6
rag_factory/models/evaluation/ab_testing.py                           97     97     0%   3-279
rag_factory/models/evaluation/models.py                               29     29     0%   3-74
rag_factory/observability/__init__.py                                  3      0   100%
rag_factory/observability/integrations/__init__.py                     1      1     0%   3
rag_factory/observability/integrations/prometheus.py                  47     47     0%   3-229
rag_factory/observability/logging/__init__.py                          2      0   100%
rag_factory/observability/logging/config.py                           16     16     0%   3-37
rag_factory/observability/logging/filters.py                          41     41     0%   3-103
rag_factory/observability/logging/logger.py                           86     46    47%   49, 99-103, 108-115, 140-162, 190-229, 250, 270, 290-291, 306, 315, 324, 333, 344-373, 394-396
rag_factory/observability/metrics/__init__.py                          2      0   100%
rag_factory/observability/metrics/collector.py                       143     96    33%   66-68, 77-79, 88-90, 99, 108, 117, 128-143, 193-198, 221-266, 284-290, 304, 335-340, 352-364, 372-404, 442-443, 457-459
rag_factory/observability/metrics/cost.py                             39     39     0%   3-221
rag_factory/observability/metrics/performance.py                      64     64     0%   3-196
rag_factory/observability/monitoring/__init__.py                       1      1     0%   3
rag_factory/observability/monitoring/api.py                          101    101     0%   3-328
rag_factory/pipeline.py                                              156    108    31%   160-167, 184-188, 205-209, 222-254, 277-312, 335-377, 402-406, 422-430, 444-450, 501-507
rag_factory/repositories/__init__.py                                   5      0   100%
rag_factory/repositories/base.py                                      42     20    52%   53, 70, 87, 103, 114-118, 125, 136-139, 159-164
rag_factory/repositories/chunk.py                                    206     59    71%   75-76, 94-95, 200-202, 229-231, 358, 360, 395-396, 425, 438, 473-474, 519-521, 537-543, 557-563, 577-587, 604-626, 639-670
rag_factory/repositories/document.py                                  93     74    20%   41-46, 63-68, 98-118, 140-156, 172-187, 206, 223-233, 247-255, 272-279, 290-293, 307-312
rag_factory/repositories/exceptions.py                                18      4    78%   56-59
rag_factory/services/__init__.py                                       8      0   100%
rag_factory/services/api/__init__.py                                   4      0   100%
rag_factory/services/api/anthropic.py                                 27     10    63%   118-141
rag_factory/services/api/cohere.py                                    30      7    77%   14-15, 50, 83, 111-113
rag_factory/services/api/openai.py                                    46     31    33%   45-51, 75-93, 117-140, 168-174, 189-199, 216-227, 235
rag_factory/services/consistency.py                                   32     24    25%   80-113, 144-170
rag_factory/services/database/__init__.py                              3      0   100%
rag_factory/services/database/neo4j.py                                54     36    33%   14, 60-71, 79-84, 103-114, 134-150, 172-181, 188-191, 195, 199
rag_factory/services/database/postgres.py                             91     49    46%   17-18, 73, 109-111, 115-139, 157-185, 212-242, 258-271, 287, 291-301, 333-351, 359-361
rag_factory/services/dependencies.py                                  41     21    49%   96-109, 134-140, 176-180
rag_factory/services/embedding/__init__.py                             4      0   100%
rag_factory/services/embedding/base.py                                31      6    81%   44, 59, 68, 77, 86, 98
rag_factory/services/embedding/cache.py                               43     33    23%   26-32, 43-58, 67-76, 80-82, 90-94
rag_factory/services/embedding/config.py                              29     13    55%   37-43, 50-68, 80
rag_factory/services/embedding/providers/__init__.py                   5      0   100%
rag_factory/services/embedding/providers/cohere.py                    53     36    32%   10-20, 55-75, 90-117, 125, 133, 141, 152-153
rag_factory/services/embedding/providers/local.py                     43     27    37%   8-9, 46-67, 83-109, 117, 125, 133, 146
rag_factory/services/embedding/providers/onnx_local.py               116     10    91%   18-19, 24-25, 121, 145, 154, 165, 273, 298
rag_factory/services/embedding/providers/openai.py                    51     34    33%   10-20, 53-72, 87-108, 116, 124, 132, 143-144
rag_factory/services/embedding/rate_limiter.py                        20      1    95%   32
rag_factory/services/embedding/service.py                            100     83    17%   50-62, 79-93, 117-198, 220-222, 233-239, 248-266, 273-275
rag_factory/services/interfaces.py                                    35      0   100%
rag_factory/services/llm/__init__.py                                   5      0   100%
rag_factory/services/llm/base.py                                      43      0   100%
rag_factory/services/llm/config.py                                    23      6    74%   46-48, 51-53
rag_factory/services/llm/prompt_template.py                           43     24    44%   47-82, 97-100, 111-115
rag_factory/services/llm/providers/__init__.py                        12     10    17%   10-22
rag_factory/services/llm/providers/anthropic.py                       57     42    26%   44-50, 64-97, 120-147, 171-172, 184-189, 197, 205
rag_factory/services/llm/providers/ollama.py                          55     42    24%   22-24, 37-67, 93-122, 142-143, 157, 165, 174, 185-196
rag_factory/services/llm/providers/openai.py                          57     20    65%   56, 62, 101-105, 133-158, 189-194, 202, 210
rag_factory/services/llm/service.py                                   66     25    62%   68, 94, 127-129, 154-175, 186, 194-198, 215-216
rag_factory/services/llm/token_counter.py                             27      4    85%   56-57, 71-72
rag_factory/services/local/__init__.py                                 2      0   100%
rag_factory/services/local/reranker.py                                32      7    78%   13-14, 46, 79, 114-116
rag_factory/services/onnx/__init__.py                                  2      0   100%
rag_factory/services/onnx/embedding.py                                29      9    69%   61, 63, 65, 93, 110-121
rag_factory/services/utils/__init__.py                                 2      0   100%
rag_factory/services/utils/model_converter.py                        104    104     0%   8-291
rag_factory/services/utils/onnx_utils.py                             171    137    20%   22-23, 28-29, 40-48, 81-193, 213-234, 260-306, 328-362, 379-400, 449-450, 464, 480-492
rag_factory/services/utils/reranker_selector.py                       68     68     0%   8-249
rag_factory/strategies/__init__.py                                     2      0   100%
rag_factory/strategies/agentic/__init__.py                             7      0   100%
rag_factory/strategies/agentic/agent.py                              151    130    14%   31-36, 45, 57, 66-90, 109-111, 123-161, 190-214, 230-265, 276-293, 310-331, 339-346, 357-368, 381-420
rag_factory/strategies/agentic/config.py                              12      0   100%
rag_factory/strategies/agentic/frameworks/__init__.py                  1      1     0%   9
rag_factory/strategies/agentic/query_analyzer.py                      89     65    27%   50-55, 67, 79-90, 109-125, 137-147, 159-178, 196-214, 225-260, 278
rag_factory/strategies/agentic/strategy.py                            76     53    30%   48-64, 76, 87-95, 107, 119, 132, 145-185, 197-221, 230, 239, 247
rag_factory/strategies/agentic/tool_implementations.py               135     91    33%   36-37, 41, 45, 52, 86-129, 148-149, 153, 157, 164, 182-247, 266-267, 271, 275, 282, 329-373, 392-393, 397, 401, 407, 446-511
rag_factory/strategies/agentic/tools.py                               40      9    78%   66, 79, 89, 101, 112, 139-142
rag_factory/strategies/base.py                                        55     13    76%   80-85, 169-178
rag_factory/strategies/chunking/__init__.py                           15      4    73%   45-48
rag_factory/strategies/chunking/base.py                               91     35    62%   115-128, 146, 159, 171, 182-196, 207-217, 228-256
rag_factory/strategies/chunking/docling_chunker.py                    45     26    42%   18, 61-73, 89-101, 112, 131-136, 147-152, 163-168, 186-188
rag_factory/strategies/chunking/fixed_size_chunker.py                 74     61    18%   8-9, 33-46, 58-111, 122, 145-159, 171-185, 196-204
rag_factory/strategies/chunking/hybrid_chunker.py                     70     58    17%   36-48, 63-132, 143, 157-160, 173-192
rag_factory/strategies/chunking/semantic_chunker.py                  195    171    12%   9-10, 14-15, 45-71, 83-128, 139, 155-156, 172-177, 193-206, 218-227, 245-277, 293-328, 340-386, 397-423, 434-441, 459-473, 485-534
rag_factory/strategies/chunking/structural_chunker.py                147    128    13%   9-10, 37-50, 62-69, 80, 95, 107-144, 155-201, 222-288, 299-305, 317-366, 377-385, 399-425
rag_factory/strategies/chunking/utils.py                              89     89     0%   3-264
rag_factory/strategies/contextual/__init__.py                          7      7     0%   8-19
rag_factory/strategies/contextual/batch_processor.py                  86     86     0%   8-257
rag_factory/strategies/contextual/config.py                           46     46     0%   8-195
rag_factory/strategies/contextual/context_generator.py                84     84     0%   8-234
rag_factory/strategies/contextual/cost_tracker.py                     32     32     0%   8-126
rag_factory/strategies/contextual/prompts.py                          25     25     0%   8-119
rag_factory/strategies/contextual/storage.py                          44     44     0%   8-118
rag_factory/strategies/contextual/strategy.py                         65     65     0%   8-278
rag_factory/strategies/fine_tuned/__init__.py                          4      4     0%   1-5
rag_factory/strategies/fine_tuned/ab_testing.py                       78     78     0%   1-134
rag_factory/strategies/fine_tuned/config.py                           11     11     0%   1-30
rag_factory/strategies/fine_tuned/custom_loader.py                    40     40     0%   1-88
rag_factory/strategies/fine_tuned/model_registry.py                  126    126     0%   1-303
rag_factory/strategies/hierarchical/__init__.py                        5      5     0%   8-21
rag_factory/strategies/hierarchical/hierarchy_builder.py              79     79     0%   8-335
rag_factory/strategies/hierarchical/models.py                         58     58     0%   8-137
rag_factory/strategies/hierarchical/parent_retriever.py               89     89     0%   8-278
rag_factory/strategies/hierarchical/strategy.py                       66     66     0%   9-284
rag_factory/strategies/indexing/__init__.py                            5      0   100%
rag_factory/strategies/indexing/context_aware.py                      97     79    19%   29, 40, 60-120, 141-142, 146-156, 168-174, 178-184, 194-223, 227-228
rag_factory/strategies/indexing/hierarchical.py                       83     68    18%   48, 60, 84-121, 143-172, 188-223, 240-265, 279-280
rag_factory/strategies/indexing/in_memory.py                          41     25    39%   54, 65, 93-121, 143, 160, 173, 194-200
rag_factory/strategies/indexing/keyword_indexing.py                   40     40     0%   8-155
rag_factory/strategies/indexing/vector_embedding.py                   29     21    28%   21, 30, 53-91
rag_factory/strategies/knowledge_graph/__init__.py                     4      4     0%   8-19
rag_factory/strategies/knowledge_graph/config.py                      21     21     0%   8-129
rag_factory/strategies/knowledge_graph/entity_extractor.py            70     70     0%   7-205
rag_factory/strategies/knowledge_graph/graph_store.py                 31     31     0%   8-124
rag_factory/strategies/knowledge_graph/hybrid_retriever.py            56     56     0%   8-164
rag_factory/strategies/knowledge_graph/memory_graph_store.py          97     97     0%   8-196
rag_factory/strategies/knowledge_graph/models.py                      53     53     0%   8-122
rag_factory/strategies/knowledge_graph/relationship_extractor.py      62     62     0%   8-189
rag_factory/strategies/knowledge_graph/strategy.py                    78     78     0%   8-255
rag_factory/strategies/late_chunking/__init__.py                       6      0   100%
rag_factory/strategies/late_chunking/coherence_analyzer.py            27     17    37%   20-21, 36-45, 57-65, 82-96
rag_factory/strategies/late_chunking/document_embedder.py             99     12    88%   35, 57-63, 72, 111, 225-226, 270, 296
rag_factory/strategies/late_chunking/embedding_chunker.py            112     97    13%   26, 41-61, 68-98, 105-141, 148-168, 177-178, 185-240, 251-275, 279-286
rag_factory/strategies/late_chunking/models.py                        62      0   100%
rag_factory/strategies/late_chunking/strategy.py                      49     33    33%   42-58, 68-105, 124-133, 138, 143
rag_factory/strategies/multi_query/__init__.py                         7      7     0%   8-19
rag_factory/strategies/multi_query/config.py                          36     36     0%   3-138
rag_factory/strategies/multi_query/deduplicator.py                    87     87     0%   3-197
rag_factory/strategies/multi_query/parallel_executor.py               52     52     0%   3-163
rag_factory/strategies/multi_query/prompts.py                         10     10     0%   3-84
rag_factory/strategies/multi_query/ranker.py                          80     80     0%   3-201
rag_factory/strategies/multi_query/strategy.py                        66     66     0%   3-182
rag_factory/strategies/multi_query/variant_generator.py               62     62     0%   3-187
rag_factory/strategies/query_expansion/__init__.py                     8      0   100%
rag_factory/strategies/query_expansion/base.py                        66      3    95%   103, 115, 118
rag_factory/strategies/query_expansion/cache.py                       52     25    52%   47-51, 70-73, 81-97, 105-112
rag_factory/strategies/query_expansion/expander_service.py            91      3    97%   171, 276-277
rag_factory/strategies/query_expansion/hyde_expander.py               19      1    95%   48
rag_factory/strategies/query_expansion/llm_expander.py                25      0   100%
rag_factory/strategies/query_expansion/metrics.py                     66     30    55%   44-45, 53-57, 76-109, 130, 134, 146-152, 160
rag_factory/strategies/query_expansion/prompts.py                     13      1    92%   29
rag_factory/strategies/reranking/__init__.py                           7      0   100%
rag_factory/strategies/reranking/base.py                              68     16    76%   81, 101, 106, 110-119, 123-130
rag_factory/strategies/reranking/bge_reranker.py                      51     37    27%   14, 53-81, 103-147, 151
rag_factory/strategies/reranking/cache.py                             48     34    29%   32-34, 51-66, 76-77, 81, 90-101, 110-113, 121, 136-138
rag_factory/strategies/reranking/cohere_reranker.py                   34     20    41%   15-16, 55-71, 94-115, 119
rag_factory/strategies/reranking/cosine_reranker.py                   62     47    24%   54-72, 97-139, 158-171, 188, 209-215, 227-230, 242-245, 249
rag_factory/strategies/reranking/cross_encoder_reranker.py            40     27    32%   13-14, 53-76, 98-120, 124
rag_factory/strategies/reranking/metrics.py                           67     67     0%   8-264
rag_factory/strategies/reranking/reranker_service.py                 115     88    23%   56-67, 71-96, 113-225, 235-255, 269, 282-283, 287-292, 296-300, 308-310
rag_factory/strategies/self_reflective/__init__.py                     6      6     0%   3-16
rag_factory/strategies/self_reflective/config.py                      20     20     0%   3-42
rag_factory/strategies/self_reflective/grader.py                      80     80     0%   3-266
rag_factory/strategies/self_reflective/models.py                      48     48     0%   3-109
rag_factory/strategies/self_reflective/refiner.py                     69     69     0%   3-228
rag_factory/strategies/self_reflective/strategy.py                    89     89     0%   3-264
rag_factory/utils/__init__.py                                          3      0   100%
rag_factory/utils/token_counter.py                                    45     30    33%   36-40, 52-62, 74-82, 86, 90, 105-106, 124-135, 153-158
rag_factory/utils/tokenization.py                                     95     59    38%   39-40, 53-64, 93-94, 100-101, 105-114, 129, 141-144, 156, 175-190, 209-228, 241-243, 251-252, 270-271, 292-293, 314-315
------------------------------------------------------------------------------------------------
TOTAL                                                              11084   8219    26%
=========================== short test summary info ============================
FAILED tests/integration/services/test_service_implementations.py::TestDatabaseServices::test_postgresql_database_service_basic_functionality
FAILED tests/integration/strategies/test_query_expansion_integration.py::TestQueryExpansionIntegration::test_cache_functionality
FAILED tests/unit/strategies/agentic/test_strategy.py::test_strategy_initialization
FAILED tests/unit/strategies/agentic/test_strategy.py::test_strategy_initialization_with_config
FAILED tests/unit/strategies/agentic/test_strategy.py::test_strategy_retrieve
FAILED tests/unit/strategies/agentic/test_strategy.py::test_strategy_retrieve_with_query_analysis
FAILED tests/unit/strategies/agentic/test_strategy.py::test_strategy_fallback_on_error
FAILED tests/unit/strategies/agentic/test_strategy.py::test_strategy_no_fallback_raises_error
FAILED tests/unit/strategies/agentic/test_strategy.py::test_strategy_get_stats
FAILED tests/unit/strategies/agentic/test_strategy.py::test_strategy_top_k_limit
FAILED tests/unit/documentation/test_links.py::TestDocumentationLinks::test_no_broken_internal_links
FAILED tests/unit/documentation/test_links.py::TestDocumentationLinks::test_all_diagrams_valid
FAILED tests/unit/documentation/test_links.py::TestDocumentationLinks::test_no_todo_links
FAILED tests/unit/documentation/test_code_examples.py::TestCodeExamples::test_all_code_examples_have_valid_syntax
FAILED tests/unit/documentation/test_code_examples.py::TestCodeExamples::test_no_placeholder_code
FAILED tests/unit/cli/test_check_consistency_command.py::TestCheckConsistencyCommand::test_config_file_loading
FAILED tests/unit/cli/test_repl_command.py::TestREPLSession::test_repl_session_init
FAILED tests/unit/services/test_interfaces.py::test_idatabase_service_mock_implementation
FAILED tests/unit/services/test_database_service.py::test_ensure_table - Conn...
FAILED tests/unit/services/test_database_service.py::test_store_chunks - Conn...
FAILED tests/unit/services/test_database_service.py::test_search_chunks - Con...
FAILED tests/unit/services/test_database_service.py::test_get_chunk - Connect...
FAILED tests/unit/services/test_database_service.py::test_get_chunk_not_found
FAILED tests/unit/services/test_database_service.py::test_get_chunks_for_documents
FAILED tests/unit/services/test_database_service.py::test_close - ConnectionR...
FAILED tests/unit/services/test_database_service.py::test_context_manager - C...
FAILED tests/unit/documentation/test_documentation_completeness.py::TestDocumentationCompleteness::test_mkdocs_config_valid
FAILED tests/unit/database/test_migrations.py::TestAlembicMigrations::test_migration_downgrade
FAILED tests/unit/database/test_migrations.py::TestAlembicMigrations::test_migration_creates_tables
FAILED tests/unit/database/test_migrations.py::TestAlembicMigrations::test_migration_creates_indexes
FAILED tests/unit/repositories/test_chunk_repository.py::TestChunkRepositoryVectorSearch::test_search_similar_with_filter_success
FAILED tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_tokenization_with_tiktoken
FAILED tests/unit/services/embeddings/test_onnx_local.py::TestONNXLocalProvider::test_tokenization_simple_fallback
FAILED tests/unit/services/embedding/test_onnx_local_provider.py::test_mean_pooling
FAILED tests/unit/strategies/late_chunking/test_document_embedder.py::test_long_document_truncation
FAILED tests/unit/strategies/late_chunking/test_document_embedder.py::test_embedding_dimensions_consistent
FAILED tests/unit/test_pipeline.py::test_pipeline_add_stage - TypeError: Can'...
FAILED tests/unit/test_pipeline.py::test_pipeline_chaining - TypeError: Can't...
FAILED tests/unit/test_pipeline.py::test_sequential_execution_order - TypeErr...
FAILED tests/unit/test_pipeline.py::test_sequential_execution_collects_results
FAILED tests/unit/test_pipeline.py::test_parallel_execution - TypeError: Can'...
FAILED tests/unit/test_pipeline.py::test_strategy_error_caught - TypeError: C...
FAILED tests/unit/test_pipeline.py::test_fallback_strategy_executed - TypeErr...
FAILED tests/unit/test_pipeline.py::test_duplicate_results_removed - TypeErro...
FAILED tests/unit/test_pipeline.py::test_results_sorted_by_score - TypeError:...
FAILED tests/unit/test_pipeline.py::test_performance_metrics_collected - Type...
FAILED tests/unit/test_pipeline.py::test_from_config_creates_pipeline - TypeE...
FAILED tests/unit/test_pipeline.py::test_cascade_mode_not_implemented - TypeE...
FAILED tests/unit/test_pipeline.py::test_cascade_mode_not_implemented_async
FAILED tests/unit/test_pipeline.py::test_required_stage_failure_raises_exception
FAILED tests/unit/test_pipeline.py::test_required_stage_failure_raises_exception_async
FAILED tests/unit/test_pipeline.py::test_fallback_failure_when_required - Typ...
FAILED tests/unit/test_pipeline.py::test_fallback_failure_when_required_async
FAILED tests/unit/test_pipeline.py::test_parallel_required_stage_failure - Ty...
FAILED tests/unit/test_pipeline.py::test_parallel_required_fallback_failure
FAILED tests/unit/test_pipeline.py::test_non_required_fallback_failure_continues
FAILED tests/unit/test_pipeline.py::test_non_required_fallback_failure_continues_async
FAILED tests/unit/test_pipeline.py::test_parallel_non_required_fallback_success
FAILED tests/unit/test_pipeline.py::test_parallel_non_required_both_fail - Ty...
============ 59 failed, 147 passed, 3 skipped, 6 warnings in 44.01s ============

========================================
Test run completed at 2025-12-14 07:32:23
========================================
